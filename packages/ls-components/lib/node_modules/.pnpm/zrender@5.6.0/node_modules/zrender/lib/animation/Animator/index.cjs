"use strict";var X=Object.defineProperty;var p=(i,e)=>X(i,"name",{value:e,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const Z=require("../Clip/index.cjs"),R=require("../../tool/color/index.cjs"),_=require("../../core/util/index.cjs"),w=require("../easing/index.cjs"),H=require("../cubicEasing/index.cjs"),O=require("../../svg/helper/index.cjs");var P=Array.prototype.slice;function g(i,e,r){return(e-i)*r+i}p(g,"interpolateNumber");function D(i,e,r,t){for(var s=e.length,a=0;a<s;a++)i[a]=g(e[a],r[a],t);return i}p(D,"interpolate1DArray");function V(i,e,r,t){for(var s=e.length,a=s&&e[0].length,o=0;o<s;o++){i[o]||(i[o]=[]);for(var n=0;n<a;n++)i[o][n]=g(e[o][n],r[o][n],t)}return i}p(V,"interpolate2DArray");function E(i,e,r,t){for(var s=e.length,a=0;a<s;a++)i[a]=e[a]+r[a]*t;return i}p(E,"add1DArray");function W(i,e,r,t){for(var s=e.length,a=s&&e[0].length,o=0;o<s;o++){i[o]||(i[o]=[]);for(var n=0;n<a;n++)i[o][n]=e[o][n]+r[o][n]*t}return i}p(W,"add2DArray");function $(i,e){for(var r=i.length,t=e.length,s=r>t?e:i,a=Math.min(r,t),o=s[a-1]||{color:[0,0,0,0],offset:0},n=a;n<Math.max(r,t);n++)s.push({offset:o.offset,color:o.color.slice()})}p($,"fillColorStops");function j(i,e,r){var t=i,s=e;if(!(!t.push||!s.push)){var a=t.length,o=s.length;if(a!==o){var n=a>o;if(n)t.length=o;else for(var h=a;h<o;h++)t.push(r===1?s[h]:P.call(s[h]))}for(var l=t[0]&&t[0].length,h=0;h<t.length;h++)if(r===1)isNaN(t[h])&&(t[h]=s[h]);else for(var f=0;f<l;f++)isNaN(t[h][f])&&(t[h][f]=s[h][f])}}p(j,"fillArray");function S(i){if(_.isArrayLike(i)){var e=i.length;if(_.isArrayLike(i[0])){for(var r=[],t=0;t<e;t++)r.push(P.call(i[t]));return r}return P.call(i)}return i}p(S,"cloneValue");function N(i){return i[0]=Math.floor(i[0])||0,i[1]=Math.floor(i[1])||0,i[2]=Math.floor(i[2])||0,i[3]=i[3]==null?1:i[3],"rgba("+i.join(",")+")"}p(N,"rgba2String");function ee(i){return _.isArrayLike(i&&i[0])?2:1}p(ee,"guessArrayDim");var L=0,M=1,J=2,F=3,K=4,U=5,B=6;function z(i){return i===K||i===U}p(z,"isGradientValueType");function x(i){return i===M||i===J}p(x,"isArrayValueType");var C=[0,0,0,0],te=function(){function i(e){this.keyframes=[],this.discrete=!1,this._invalid=!1,this._needsSort=!1,this._lastFr=0,this._lastFrP=0,this.propName=e}return p(i,"Track"),i.prototype.isFinished=function(){return this._finished},i.prototype.setFinished=function(){this._finished=!0,this._additiveTrack&&this._additiveTrack.setFinished()},i.prototype.needsAnimate=function(){return this.keyframes.length>=1},i.prototype.getAdditiveTrack=function(){return this._additiveTrack},i.prototype.addKeyframe=function(e,r,t){this._needsSort=!0;var s=this.keyframes,a=s.length,o=!1,n=B,h=r;if(_.isArrayLike(r)){var l=ee(r);n=l,(l===1&&!_.isNumber(r[0])||l===2&&!_.isNumber(r[0][0]))&&(o=!0)}else if(_.isNumber(r)&&!_.eqNaN(r))n=L;else if(_.isString(r))if(!isNaN(+r))n=L;else{var f=R.parse(r);f&&(h=f,n=F)}else if(_.isGradientObject(r)){var m=_.extend({},h);m.colorStops=_.map(r.colorStops,function(u){return{offset:u.offset,color:R.parse(u.color)}}),O.isLinearGradient(r)?n=K:O.isRadialGradient(r)&&(n=U),h=m}a===0?this.valType=n:(n!==this.valType||n===B)&&(o=!0),this.discrete=this.discrete||o;var d={time:e,value:h,rawValue:r,percent:0};return t&&(d.easing=t,d.easingFunc=_.isFunction(t)?t:w.default[t]||H.createCubicEasingFunc(t)),s.push(d),d},i.prototype.prepare=function(e,r){var t=this.keyframes;this._needsSort&&t.sort(function(A,y){return A.time-y.time});for(var s=this.valType,a=t.length,o=t[a-1],n=this.discrete,h=x(s),l=z(s),f=0;f<a;f++){var m=t[f],d=m.value,u=o.value;m.percent=m.time/e,n||(h&&f!==a-1?j(d,u,s):l&&$(d.colorStops,u.colorStops))}if(!n&&s!==U&&r&&this.needsAnimate()&&r.needsAnimate()&&s===r.valType&&!r._finished){this._additiveTrack=r;for(var v=t[0].value,f=0;f<a;f++)s===L?t[f].additiveValue=t[f].value-v:s===F?t[f].additiveValue=E([],t[f].value,v,-1):x(s)&&(t[f].additiveValue=s===M?E([],t[f].value,v,-1):W([],t[f].value,v,-1))}},i.prototype.step=function(e,r){if(!this._finished){this._additiveTrack&&this._additiveTrack._finished&&(this._additiveTrack=null);var t=this._additiveTrack!=null,s=t?"additiveValue":"value",a=this.valType,o=this.keyframes,n=o.length,h=this.propName,l=a===F,f,m=this._lastFr,d=Math.min,u,v;if(n===1)u=v=o[0];else{if(r<0)f=0;else if(r<this._lastFrP){var A=d(m+1,n-1);for(f=A;f>=0&&!(o[f].percent<=r);f--);f=d(f,n-2)}else{for(f=m;f<n&&!(o[f].percent>r);f++);f=d(f-1,n-2)}v=o[f+1],u=o[f]}if(u&&v){this._lastFr=f,this._lastFrP=r;var y=v.percent-u.percent,c=y===0?1:d((r-u.percent)/y,1);v.easingFunc&&(c=v.easingFunc(c));var k=t?this._additiveValue:l?C:e[h];if((x(a)||l)&&!k&&(k=this._additiveValue=[]),this.discrete)e[h]=c<1?u.rawValue:v.rawValue;else if(x(a))a===M?D(k,u[s],v[s],c):V(k,u[s],v[s],c);else if(z(a)){var b=u[s],T=v[s],Y=a===K;e[h]={type:Y?"linear":"radial",x:g(b.x,T.x,c),y:g(b.y,T.y,c),colorStops:_.map(b.colorStops,function(G,Q){var I=T.colorStops[Q];return{offset:g(G.offset,I.offset,c),color:N(D([],G.color,I.color,c))}}),global:T.global},Y?(e[h].x2=g(b.x2,T.x2,c),e[h].y2=g(b.y2,T.y2,c)):e[h].r=g(b.r,T.r,c)}else if(l)D(k,u[s],v[s],c),t||(e[h]=N(k));else{var q=g(u[s],v[s],c);t?this._additiveValue=q:e[h]=q}t&&this._addToTarget(e)}}},i.prototype._addToTarget=function(e){var r=this.valType,t=this.propName,s=this._additiveValue;r===L?e[t]=e[t]+s:r===F?(R.parse(e[t],C),E(C,C,s,1),e[t]=N(C)):r===M?E(e[t],e[t],s,1):r===J&&W(e[t],e[t],s,1)},i}(),re=function(){function i(e,r,t,s){if(this._tracks={},this._trackKeys=[],this._maxTime=0,this._started=0,this._clip=null,this._target=e,this._loop=r,r&&s){_.logError("Can' use additive animation on looped animation.");return}this._additiveAnimators=s,this._allowDiscrete=t}return p(i,"Animator"),i.prototype.getMaxTime=function(){return this._maxTime},i.prototype.getDelay=function(){return this._delay},i.prototype.getLoop=function(){return this._loop},i.prototype.getTarget=function(){return this._target},i.prototype.changeTarget=function(e){this._target=e},i.prototype.when=function(e,r,t){return this.whenWithKeys(e,r,_.keys(r),t)},i.prototype.whenWithKeys=function(e,r,t,s){for(var a=this._tracks,o=0;o<t.length;o++){var n=t[o],h=a[n];if(!h){h=a[n]=new te(n);var l=void 0,f=this._getAdditiveTrack(n);if(f){var m=f.keyframes,d=m[m.length-1];l=d&&d.value,f.valType===F&&l&&(l=N(l))}else l=this._target[n];if(l==null)continue;e>0&&h.addKeyframe(0,S(l),s),this._trackKeys.push(n)}h.addKeyframe(e,S(r[n]),s)}return this._maxTime=Math.max(this._maxTime,e),this},i.prototype.pause=function(){this._clip.pause(),this._paused=!0},i.prototype.resume=function(){this._clip.resume(),this._paused=!1},i.prototype.isPaused=function(){return!!this._paused},i.prototype.duration=function(e){return this._maxTime=e,this._force=!0,this},i.prototype._doneCallback=function(){this._setTracksFinished(),this._clip=null;var e=this._doneCbs;if(e)for(var r=e.length,t=0;t<r;t++)e[t].call(this)},i.prototype._abortedCallback=function(){this._setTracksFinished();var e=this.animation,r=this._abortedCbs;if(e&&e.removeClip(this._clip),this._clip=null,r)for(var t=0;t<r.length;t++)r[t].call(this)},i.prototype._setTracksFinished=function(){for(var e=this._tracks,r=this._trackKeys,t=0;t<r.length;t++)e[r[t]].setFinished()},i.prototype._getAdditiveTrack=function(e){var r,t=this._additiveAnimators;if(t)for(var s=0;s<t.length;s++){var a=t[s].getTrack(e);a&&(r=a)}return r},i.prototype.start=function(e){if(!(this._started>0)){this._started=1;for(var r=this,t=[],s=this._maxTime||0,a=0;a<this._trackKeys.length;a++){var o=this._trackKeys[a],n=this._tracks[o],h=this._getAdditiveTrack(o),l=n.keyframes,f=l.length;if(n.prepare(s,h),n.needsAnimate())if(!this._allowDiscrete&&n.discrete){var m=l[f-1];m&&(r._target[n.propName]=m.rawValue),n.setFinished()}else t.push(n)}if(t.length||this._force){var d=new Z.default({life:s,loop:this._loop,delay:this._delay||0,onframe:p(function(u){r._started=2;var v=r._additiveAnimators;if(v){for(var A=!1,y=0;y<v.length;y++)if(v[y]._clip){A=!0;break}A||(r._additiveAnimators=null)}for(var y=0;y<t.length;y++)t[y].step(r._target,u);var c=r._onframeCbs;if(c)for(var y=0;y<c.length;y++)c[y](r._target,u)},"onframe"),ondestroy:p(function(){r._doneCallback()},"ondestroy")});this._clip=d,this.animation&&this.animation.addClip(d),e&&d.setEasing(e)}else this._doneCallback();return this}},i.prototype.stop=function(e){if(this._clip){var r=this._clip;e&&r.onframe(1),this._abortedCallback()}},i.prototype.delay=function(e){return this._delay=e,this},i.prototype.during=function(e){return e&&(this._onframeCbs||(this._onframeCbs=[]),this._onframeCbs.push(e)),this},i.prototype.done=function(e){return e&&(this._doneCbs||(this._doneCbs=[]),this._doneCbs.push(e)),this},i.prototype.aborted=function(e){return e&&(this._abortedCbs||(this._abortedCbs=[]),this._abortedCbs.push(e)),this},i.prototype.getClip=function(){return this._clip},i.prototype.getTrack=function(e){return this._tracks[e]},i.prototype.getTracks=function(){var e=this;return _.map(this._trackKeys,function(r){return e._tracks[r]})},i.prototype.stopTracks=function(e,r){if(!e.length||!this._clip)return!0;for(var t=this._tracks,s=this._trackKeys,a=0;a<e.length;a++){var o=t[e[a]];o&&!o.isFinished()&&(r?o.step(this._target,1):this._started===1&&o.step(this._target,0),o.setFinished())}for(var n=!0,a=0;a<s.length;a++)if(!t[s[a]].isFinished()){n=!1;break}return n&&this._abortedCallback(),n},i.prototype.saveTo=function(e,r,t){if(e){r=r||this._trackKeys;for(var s=0;s<r.length;s++){var a=r[s],o=this._tracks[a];if(!(!o||o.isFinished())){var n=o.keyframes,h=n[t?0:n.length-1];h&&(e[a]=S(h.rawValue))}}}},i.prototype.__changeFinalValue=function(e,r){r=r||_.keys(e);for(var t=0;t<r.length;t++){var s=r[t],a=this._tracks[s];if(a){var o=a.keyframes;if(o.length>1){var n=o.pop();a.addKeyframe(n.time,e[s]),a.prepare(this._maxTime,a.getAdditiveTrack())}}}},i}();exports.cloneValue=S;exports.default=re;
