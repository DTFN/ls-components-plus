"use strict";var F=Object.defineProperty;var g=(m,f)=>F(m,"name",{value:f,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const L=require("../../../../../../tslib@2.3.0/node_modules/tslib/tslib.es6/index.cjs"),k=require("../../core/util/index.cjs"),U=require("../../config/index.cjs"),W=require("../../core/Eventful/index.cjs"),G=require("../helper/index.cjs"),O=require("../graphic/index.cjs"),w=require("../../core/BoundingRect/index.cjs"),E=require("../../graphic/constants/index.cjs"),X=require("../../core/platform/index.cjs");function T(m,f,a){var e=X.platformApi.createCanvas(),s=f.getWidth(),i=f.getHeight(),t=e.style;return t&&(t.position="absolute",t.left="0",t.top="0",t.width=s+"px",t.height=i+"px",e.setAttribute("data-zr-dom-id",m)),e.width=s*a,e.height=i*a,e}g(T,"createDom");var Y=function(m){L.__extends(f,m);function f(a,e,s){var i=m.call(this)||this;i.motionBlur=!1,i.lastFrameAlpha=.7,i.dpr=1,i.virtual=!1,i.config={},i.incremental=!1,i.zlevel=0,i.maxRepaintRectCount=5,i.__dirty=!0,i.__firstTimePaint=!0,i.__used=!1,i.__drawIndex=0,i.__startIndex=0,i.__endIndex=0,i.__prevStartIndex=null,i.__prevEndIndex=null;var t;s=s||U.devicePixelRatio,typeof a=="string"?t=T(a,e,s):k.isObject(a)&&(t=a,a=t.id),i.id=a,i.dom=t;var d=t.style;return d&&(k.disableUserSelect(t),t.onselectstart=function(){return!1},d.padding="0",d.margin="0",d.borderWidth="0"),i.painter=e,i.dpr=s,i}return g(f,"Layer"),f.prototype.getElementCount=function(){return this.__endIndex-this.__startIndex},f.prototype.afterBrush=function(){this.__prevStartIndex=this.__startIndex,this.__prevEndIndex=this.__endIndex},f.prototype.initContext=function(){this.ctx=this.dom.getContext("2d"),this.ctx.dpr=this.dpr},f.prototype.setUnpainted=function(){this.__firstTimePaint=!0},f.prototype.createBackBuffer=function(){var a=this.dpr;this.domBack=T("back-"+this.id,this.painter,a),this.ctxBack=this.domBack.getContext("2d"),a!==1&&this.ctxBack.scale(a,a)},f.prototype.createRepaintRects=function(a,e,s,i){if(this.__firstTimePaint)return this.__firstTimePaint=!1,null;var t=[],d=this.maxRepaintRectCount,c=!1,_=new w.default(0,0,0,0);function y(h){if(!(!h.isFinite()||h.isZero()))if(t.length===0){var v=new w.default(0,0,0,0);v.copy(h),t.push(v)}else{for(var B=!1,P=1/0,S=0,I=0;I<t.length;++I){var R=t[I];if(R.intersect(h)){var b=new w.default(0,0,0,0);b.copy(R),b.union(h),t[I]=b,B=!0;break}else if(c){_.copy(h),_.union(R);var A=h.width*h.height,z=R.width*R.height,D=_.width*_.height,q=D-A-z;q<P&&(P=q,S=I)}}if(c&&(t[S].union(h),B=!0),!B){var v=new w.default(0,0,0,0);v.copy(h),t.push(v)}c||(c=t.length>=d)}}g(y,"addRectToMergePool");for(var n=this.__startIndex;n<this.__endIndex;++n){var r=a[n];if(r){var x=r.shouldBePainted(s,i,!0,!0),p=r.__isRendered&&(r.__dirty&E.REDRAW_BIT||!x)?r.getPrevPaintRect():null;p&&y(p);var o=x&&(r.__dirty&E.REDRAW_BIT||!r.__isRendered)?r.getPaintRect():null;o&&y(o)}}for(var n=this.__prevStartIndex;n<this.__prevEndIndex;++n){var r=e[n],x=r&&r.shouldBePainted(s,i,!0,!0);if(r&&(!x||!r.__zr)&&r.__isRendered){var p=r.getPrevPaintRect();p&&y(p)}}var l;do{l=!1;for(var n=0;n<t.length;){if(t[n].isZero()){t.splice(n,1);continue}for(var u=n+1;u<t.length;)t[n].intersect(t[u])?(l=!0,t[n].union(t[u]),t.splice(u,1)):u++;n++}}while(l);return this._paintRects=t,t},f.prototype.debugGetPaintRects=function(){return(this._paintRects||[]).slice()},f.prototype.resize=function(a,e){var s=this.dpr,i=this.dom,t=i.style,d=this.domBack;t&&(t.width=a+"px",t.height=e+"px"),i.width=a*s,i.height=e*s,d&&(d.width=a*s,d.height=e*s,s!==1&&this.ctxBack.scale(s,s))},f.prototype.clear=function(a,e,s){var i=this.dom,t=this.ctx,d=i.width,c=i.height;e=e||this.clearColor;var _=this.motionBlur&&!a,y=this.lastFrameAlpha,n=this.dpr,r=this;_&&(this.domBack||this.createBackBuffer(),this.ctxBack.globalCompositeOperation="copy",this.ctxBack.drawImage(i,0,0,d/n,c/n));var x=this.domBack;function p(o,l,u,h){if(t.clearRect(o,l,u,h),e&&e!=="transparent"){var v=void 0;if(k.isGradientObject(e)){var B=e.global||e.__width===u&&e.__height===h;v=B&&e.__canvasGradient||G.getCanvasGradient(t,e,{x:0,y:0,width:u,height:h}),e.__canvasGradient=v,e.__width=u,e.__height=h}else k.isImagePatternObject(e)&&(e.scaleX=e.scaleX||n,e.scaleY=e.scaleY||n,v=O.createCanvasPattern(t,e,{dirty:g(function(){r.setUnpainted(),r.painter.refresh()},"dirty")}));t.save(),t.fillStyle=v||e,t.fillRect(o,l,u,h),t.restore()}_&&(t.save(),t.globalAlpha=y,t.drawImage(x,o,l,u,h),t.restore())}g(p,"doClear"),!s||_?p(0,0,d,c):s.length&&k.each(s,function(o){p(o.x*n,o.y*n,o.width*n,o.height*n)})},f}(W.default);exports.default=Y;
