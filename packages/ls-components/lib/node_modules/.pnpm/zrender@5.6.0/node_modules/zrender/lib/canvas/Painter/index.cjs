"use strict";var W=Object.defineProperty;var y=(n,e)=>W(n,"name",{value:e,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const Z=require("../../config/index.cjs"),v=require("../../core/util/index.cjs"),P=require("../Layer/index.cjs"),A=require("../../animation/requestAnimationFrame/index.cjs"),F=require("../../core/env/index.cjs"),I=require("../graphic/index.cjs"),U=require("../../graphic/constants/index.cjs"),b=require("../helper/index.cjs");var k=1e5,L=314159,E=.01,j=.001;function Y(n){return n?n.__builtin__?!0:!(typeof n.resize!="function"||typeof n.refresh!="function"):!1}y(Y,"isLayerValid");function G(n,e){var i=document.createElement("div");return i.style.cssText=["position:relative","width:"+n+"px","height:"+e+"px","padding:0","margin:0","border-width:0"].join(";")+";",i}y(G,"createRoot");var J=function(){function n(e,i,t,r){this.type="canvas",this._zlevelList=[],this._prevDisplayList=[],this._layers={},this._layerConfig={},this._needsManuallyCompositing=!1,this.type="canvas";var s=!e.nodeName||e.nodeName.toUpperCase()==="CANVAS";this._opts=t=v.extend({},t||{}),this.dpr=t.devicePixelRatio||Z.devicePixelRatio,this._singleCanvas=s,this.root=e;var a=e.style;a&&(v.disableUserSelect(e),e.innerHTML=""),this.storage=i;var f=this._zlevelList;this._prevDisplayList=[];var o=this._layers;if(s){var h=e,_=h.width,p=h.height;t.width!=null&&(_=t.width),t.height!=null&&(p=t.height),this.dpr=t.devicePixelRatio||1,h.width=_*this.dpr,h.height=p*this.dpr,this._width=_,this._height=p;var l=new P.default(h,this,this.dpr);l.__builtin__=!0,l.initContext(),o[L]=l,l.zlevel=L,f.push(L),this._domRoot=e}else{this._width=b.getSize(e,0,t),this._height=b.getSize(e,1,t);var u=this._domRoot=G(this._width,this._height);e.appendChild(u)}}return y(n,"CanvasPainter"),n.prototype.getType=function(){return"canvas"},n.prototype.isSingleCanvas=function(){return this._singleCanvas},n.prototype.getViewportRoot=function(){return this._domRoot},n.prototype.getViewportRootOffset=function(){var e=this.getViewportRoot();if(e)return{offsetLeft:e.offsetLeft||0,offsetTop:e.offsetTop||0}},n.prototype.refresh=function(e){var i=this.storage.getDisplayList(!0),t=this._prevDisplayList,r=this._zlevelList;this._redrawId=Math.random(),this._paintList(i,t,e,this._redrawId);for(var s=0;s<r.length;s++){var a=r[s],f=this._layers[a];if(!f.__builtin__&&f.refresh){var o=s===0?this._backgroundColor:null;f.refresh(o)}}return this._opts.useDirtyRect&&(this._prevDisplayList=i.slice()),this},n.prototype.refreshHover=function(){this._paintHoverList(this.storage.getDisplayList(!1))},n.prototype._paintHoverList=function(e){var i=e.length,t=this._hoverlayer;if(t&&t.clear(),!!i){for(var r={inHover:!0,viewWidth:this._width,viewHeight:this._height},s,a=0;a<i;a++){var f=e[a];f.__inHover&&(t||(t=this._hoverlayer=this.getLayer(k)),s||(s=t.ctx,s.save()),I.brush(s,f,r,a===i-1))}s&&s.restore()}},n.prototype.getHoverLayer=function(){return this.getLayer(k)},n.prototype.paintOne=function(e,i){I.brushSingle(e,i)},n.prototype._paintList=function(e,i,t,r){if(this._redrawId===r){t=t||!1,this._updateLayerStatus(e);var s=this._doPaintList(e,i,t),a=s.finished,f=s.needsRefreshHover;if(this._needsManuallyCompositing&&this._compositeManually(),f&&this._paintHoverList(e),a)this.eachLayer(function(u){u.afterBrush&&u.afterBrush()});else{var o=this;A.default(function(){o._paintList(e,i,t,r)})}}},n.prototype._compositeManually=function(){var e=this.getLayer(L).ctx,i=this._domRoot.width,t=this._domRoot.height;e.clearRect(0,0,i,t),this.eachBuiltinLayer(function(r){r.virtual&&e.drawImage(r.dom,0,0,i,t)})},n.prototype._doPaintList=function(e,i,t){for(var r=this,s=[],a=this._opts.useDirtyRect,f=0;f<this._zlevelList.length;f++){var o=this._zlevelList[f],u=this._layers[o];u.__builtin__&&u!==this._hoverlayer&&(u.__dirty||t)&&s.push(u)}for(var h=!0,_=!1,p=y(function(x){var d=s[x],c=d.ctx,m=a&&d.createRepaintRects(e,i,l._width,l._height),w=t?d.__startIndex:d.__drawIndex,S=!t&&d.incremental&&Date.now,q=S&&Date.now(),D=d.zlevel===l._zlevelList[0]?l._backgroundColor:null;if(d.__startIndex===d.__endIndex)d.clear(!1,D,m);else if(w===d.__startIndex){var N=e[w];(!N.incremental||!N.notClear||t)&&d.clear(!1,D,m)}w===-1&&(console.error("For some unknown reason. drawIndex is -1"),w=d.__startIndex);var g,T=y(function(O){var B={inHover:!1,allClipped:!1,prevEl:null,viewWidth:r._width,viewHeight:r._height};for(g=w;g<d.__endIndex;g++){var V=e[g];if(V.__inHover&&(_=!0),r._doPaintEl(V,d,a,O,B,g===d.__endIndex-1),S){var z=Date.now()-q;if(z>15)break}}B.prevElClipPaths&&c.restore()},"repaint");if(m)if(m.length===0)g=d.__endIndex;else for(var R=l.dpr,M=0;M<m.length;++M){var C=m[M];c.save(),c.beginPath(),c.rect(C.x*R,C.y*R,C.width*R,C.height*R),c.clip(),T(C),c.restore()}else c.save(),T(),c.restore();d.__drawIndex=g,d.__drawIndex<d.__endIndex&&(h=!1)},"_loop_1"),l=this,H=0;H<s.length;H++)p(H);return F.default.wxa&&v.each(this._layers,function(x){x&&x.ctx&&x.ctx.draw&&x.ctx.draw()}),{finished:h,needsRefreshHover:_}},n.prototype._doPaintEl=function(e,i,t,r,s,a){var f=i.ctx;if(t){var o=e.getPaintRect();(!r||o&&o.intersect(r))&&(I.brush(f,e,s,a),e.setPrevPaintRect(o))}else I.brush(f,e,s,a)},n.prototype.getLayer=function(e,i){this._singleCanvas&&!this._needsManuallyCompositing&&(e=L);var t=this._layers[e];return t||(t=new P.default("zr_"+e,this,this.dpr),t.zlevel=e,t.__builtin__=!0,this._layerConfig[e]?v.merge(t,this._layerConfig[e],!0):this._layerConfig[e-E]&&v.merge(t,this._layerConfig[e-E],!0),i&&(t.virtual=i),this.insertLayer(e,t),t.initContext()),t},n.prototype.insertLayer=function(e,i){var t=this._layers,r=this._zlevelList,s=r.length,a=this._domRoot,f=null,o=-1;if(t[e]){process.env.NODE_ENV!=="production"&&v.logError("ZLevel "+e+" has been used already");return}if(!Y(i)){process.env.NODE_ENV!=="production"&&v.logError("Layer of zlevel "+e+" is not valid");return}if(s>0&&e>r[0]){for(o=0;o<s-1&&!(r[o]<e&&r[o+1]>e);o++);f=t[r[o]]}if(r.splice(o+1,0,e),t[e]=i,!i.virtual)if(f){var u=f.dom;u.nextSibling?a.insertBefore(i.dom,u.nextSibling):a.appendChild(i.dom)}else a.firstChild?a.insertBefore(i.dom,a.firstChild):a.appendChild(i.dom);i.painter||(i.painter=this)},n.prototype.eachLayer=function(e,i){for(var t=this._zlevelList,r=0;r<t.length;r++){var s=t[r];e.call(i,this._layers[s],s)}},n.prototype.eachBuiltinLayer=function(e,i){for(var t=this._zlevelList,r=0;r<t.length;r++){var s=t[r],a=this._layers[s];a.__builtin__&&e.call(i,a,s)}},n.prototype.eachOtherLayer=function(e,i){for(var t=this._zlevelList,r=0;r<t.length;r++){var s=t[r],a=this._layers[s];a.__builtin__||e.call(i,a,s)}},n.prototype.getLayers=function(){return this._layers},n.prototype._updateLayerStatus=function(e){this.eachBuiltinLayer(function(_,p){_.__dirty=_.__used=!1});function i(_){s&&(s.__endIndex!==_&&(s.__dirty=!0),s.__endIndex=_)}if(y(i,"updatePrevLayer"),this._singleCanvas)for(var t=1;t<e.length;t++){var r=e[t];if(r.zlevel!==e[t-1].zlevel||r.incremental){this._needsManuallyCompositing=!0;break}}var s=null,a=0,f,o;for(o=0;o<e.length;o++){var r=e[o],u=r.zlevel,h=void 0;f!==u&&(f=u,a=0),r.incremental?(h=this.getLayer(u+j,this._needsManuallyCompositing),h.incremental=!0,a=1):h=this.getLayer(u+(a>0?E:0),this._needsManuallyCompositing),h.__builtin__||v.logError("ZLevel "+u+" has been used by unkown layer "+h.id),h!==s&&(h.__used=!0,h.__startIndex!==o&&(h.__dirty=!0),h.__startIndex=o,h.incremental?h.__drawIndex=-1:h.__drawIndex=o,i(o),s=h),r.__dirty&U.REDRAW_BIT&&!r.__inHover&&(h.__dirty=!0,h.incremental&&h.__drawIndex<0&&(h.__drawIndex=o))}i(o),this.eachBuiltinLayer(function(_,p){!_.__used&&_.getElementCount()>0&&(_.__dirty=!0,_.__startIndex=_.__endIndex=_.__drawIndex=0),_.__dirty&&_.__drawIndex<0&&(_.__drawIndex=_.__startIndex)})},n.prototype.clear=function(){return this.eachBuiltinLayer(this._clearLayer),this},n.prototype._clearLayer=function(e){e.clear()},n.prototype.setBackgroundColor=function(e){this._backgroundColor=e,v.each(this._layers,function(i){i.setUnpainted()})},n.prototype.configLayer=function(e,i){if(i){var t=this._layerConfig;t[e]?v.merge(t[e],i,!0):t[e]=i;for(var r=0;r<this._zlevelList.length;r++){var s=this._zlevelList[r];if(s===e||s===e+E){var a=this._layers[s];v.merge(a,t[e],!0)}}}},n.prototype.delLayer=function(e){var i=this._layers,t=this._zlevelList,r=i[e];r&&(r.dom.parentNode.removeChild(r.dom),delete i[e],t.splice(v.indexOf(t,e),1))},n.prototype.resize=function(e,i){if(this._domRoot.style){var t=this._domRoot;t.style.display="none";var r=this._opts,s=this.root;if(e!=null&&(r.width=e),i!=null&&(r.height=i),e=b.getSize(s,0,r),i=b.getSize(s,1,r),t.style.display="",this._width!==e||i!==this._height){t.style.width=e+"px",t.style.height=i+"px";for(var a in this._layers)this._layers.hasOwnProperty(a)&&this._layers[a].resize(e,i);this.refresh(!0)}this._width=e,this._height=i}else{if(e==null||i==null)return;this._width=e,this._height=i,this.getLayer(L).resize(e,i)}return this},n.prototype.clearLayer=function(e){var i=this._layers[e];i&&i.clear()},n.prototype.dispose=function(){this.root.innerHTML="",this.root=this.storage=this._domRoot=this._layers=null},n.prototype.getRenderedCanvas=function(e){if(e=e||{},this._singleCanvas&&!this._compositeManually)return this._layers[L].dom;var i=new P.default("image",this,e.pixelRatio||this.dpr);i.initContext(),i.clear(!1,e.backgroundColor||this._backgroundColor);var t=i.ctx;if(e.pixelRatio<=this.dpr){this.refresh();var r=i.dom.width,s=i.dom.height;this.eachLayer(function(_){_.__builtin__?t.drawImage(_.dom,0,0,r,s):_.renderToCanvas&&(t.save(),_.renderToCanvas(t),t.restore())})}else for(var a={inHover:!1,viewWidth:this._width,viewHeight:this._height},f=this.storage.getDisplayList(!0),o=0,u=f.length;o<u;o++){var h=f[o];I.brush(t,h,a,o===u-1)}return i.dom},n.prototype.getWidth=function(){return this._width},n.prototype.getHeight=function(){return this._height},n}();exports.default=J;
