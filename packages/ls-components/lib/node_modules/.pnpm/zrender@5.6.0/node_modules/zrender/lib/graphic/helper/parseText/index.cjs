"use strict";var j=Object.defineProperty;var o=(i,r)=>j(i,"name",{value:r,configurable:!0});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const K=require("../image/index.cjs"),H=require("../../../core/util/index.cjs"),m=require("../../../contain/text/index.cjs");var z=/\{([a-zA-Z0-9_]+)\|([^}]*)\}/g;function Q(i,r,a,t,n){if(!r)return"";var h=(i+"").split(`
`);n=U(r,a,t,n);for(var l=0,e=h.length;l<e;l++)h[l]=V(h[l],n);return h.join(`
`)}o(Q,"truncateText");function U(i,r,a,t){t=t||{};var n=H.extend({},t);n.font=r,a=H.retrieve2(a,"..."),n.maxIterations=H.retrieve2(t.maxIterations,2);var h=n.minChar=H.retrieve2(t.minChar,0);n.cnCharWidth=m.getWidth("å›½",r);var l=n.ascCharWidth=m.getWidth("a",r);n.placeholder=H.retrieve2(t.placeholder,"");for(var e=i=Math.max(0,i-1),c=0;c<h&&e>=l;c++)e-=l;var f=m.getWidth(a,r);return f>e&&(a="",f=0),e=i-f,n.ellipsis=a,n.ellipsisWidth=f,n.contentWidth=e,n.containerWidth=i,n}o(U,"prepareTruncateOptions");function V(i,r){var a=r.containerWidth,t=r.font,n=r.contentWidth;if(!a)return"";var h=m.getWidth(i,t);if(h<=a)return i;for(var l=0;;l++){if(h<=n||l>=r.maxIterations){i+=r.ellipsis;break}var e=l===0?S(i,n,r.ascCharWidth,r.cnCharWidth):h>0?Math.floor(i.length*n/h):0;i=i.substr(0,e),h=m.getWidth(i,t)}return i===""&&(i=r.placeholder),i}o(V,"truncateSingleLine");function S(i,r,a,t){for(var n=0,h=0,l=i.length;h<l&&n<r;h++){var e=i.charCodeAt(h);n+=0<=e&&e<=127?a:t}return h}o(S,"estimateLength");function $(i,r){i!=null&&(i+="");var a=r.overflow,t=r.padding,n=r.font,h=a==="truncate",l=m.getLineHeight(n),e=H.retrieve2(r.lineHeight,l),c=!!r.backgroundColor,f=r.lineOverflow==="truncate",u=r.width,d;u!=null&&(a==="break"||a==="breakAll")?d=i?P(i,r.font,u,a==="breakAll",0).lines:[]:d=i?i.split(`
`):[];var s=d.length*e,g=H.retrieve2(r.height,s);if(s>g&&f){var A=Math.floor(g/e);d=d.slice(0,A)}if(i&&h&&u!=null)for(var T=U(u,n,r.ellipsis,{minChar:r.truncateMinChar,placeholder:r.placeholder}),p=0;p<d.length;p++)d[p]=V(d[p],T);for(var W=g,w=0,p=0;p<d.length;p++)w=Math.max(m.getWidth(d[p],n),w);u==null&&(u=w);var C=w;return t&&(W+=t[0]+t[2],C+=t[1]+t[3],u+=t[1]+t[3]),c&&(C=u),{lines:d,height:g,outerWidth:C,outerHeight:W,lineHeight:e,calculatedLineHeight:l,contentWidth:w,contentHeight:s,width:u}}o($,"parsePlainText");var y=function(){function i(){}return o(i,"RichTextToken"),i}(),N=function(){function i(r){this.tokens=[],r&&(this.tokens=r)}return o(i,"RichTextLine"),i}(),X=function(){function i(){this.width=0,this.height=0,this.contentWidth=0,this.contentHeight=0,this.outerWidth=0,this.outerHeight=0,this.lines=[]}return o(i,"RichTextContentBlock"),i}();function k(i,r){var a=new X;if(i!=null&&(i+=""),!i)return a;for(var t=r.width,n=r.height,h=r.overflow,l=(h==="break"||h==="breakAll")&&t!=null?{width:t,accumWidth:0,breakAll:h==="breakAll"}:null,e=z.lastIndex=0,c;(c=z.exec(i))!=null;){var f=c.index;f>e&&D(a,i.substring(e,f),r,l),D(a,c[2],r,l,c[1]),e=z.lastIndex}e<i.length&&D(a,i.substring(e,i.length),r,l);var u=[],d=0,s=0,g=r.padding,A=h==="truncate",T=r.lineOverflow==="truncate";function p(Z,_,J){Z.width=_,Z.lineHeight=J,d+=J,s=Math.max(s,_)}o(p,"finishLine");r:for(var W=0;W<a.lines.length;W++){for(var w=a.lines[W],C=0,x=0,F=0;F<w.tokens.length;F++){var v=w.tokens[F],b=v.styleName&&r.rich[v.styleName]||{},M=v.textPadding=b.padding,q=M?M[1]+M[3]:0,O=v.font=b.font||r.font;v.contentHeight=m.getLineHeight(O);var E=H.retrieve2(b.height,v.contentHeight);if(v.innerHeight=E,M&&(E+=M[0]+M[2]),v.height=E,v.lineHeight=H.retrieve3(b.lineHeight,r.lineHeight,E),v.align=b&&b.align||r.align,v.verticalAlign=b&&b.verticalAlign||"middle",T&&n!=null&&d+v.lineHeight>n){F>0?(w.tokens=w.tokens.slice(0,F),p(w,x,C),a.lines=a.lines.slice(0,W+1)):a.lines=a.lines.slice(0,W);break r}var R=b.width,G=R==null||R==="auto";if(typeof R=="string"&&R.charAt(R.length-1)==="%")v.percentWidth=R,u.push(v),v.contentWidth=m.getWidth(v.text,O);else{if(G){var Y=b.backgroundColor,L=Y&&Y.image;L&&(L=K.findExistImage(L),K.isImageReady(L)&&(v.width=Math.max(v.width,L.width*E/L.height)))}var B=A&&t!=null?t-x:null;B!=null&&B<v.width?!G||B<q?(v.text="",v.width=v.contentWidth=0):(v.text=Q(v.text,B-q,O,r.ellipsis,{minChar:r.truncateMinChar}),v.width=v.contentWidth=m.getWidth(v.text,O)):v.contentWidth=m.getWidth(v.text,O)}v.width+=q,x+=v.width,b&&(C=Math.max(C,v.lineHeight))}p(w,x,C)}a.outerWidth=a.width=H.retrieve2(t,s),a.outerHeight=a.height=H.retrieve2(n,d),a.contentHeight=d,a.contentWidth=s,g&&(a.outerWidth+=g[1]+g[3],a.outerHeight+=g[0]+g[2]);for(var W=0;W<u.length;W++){var v=u[W],I=v.percentWidth;v.width=parseInt(I,10)/100*a.width}return a}o(k,"parseRichText");function D(i,r,a,t,n){var h=r==="",l=n&&a.rich[n]||{},e=i.lines,c=l.font||a.font,f=!1,u,d;if(t){var s=l.padding,g=s?s[1]+s[3]:0;if(l.width!=null&&l.width!=="auto"){var A=m.parsePercent(l.width,t.width)+g;e.length>0&&A+t.accumWidth>t.width&&(u=r.split(`
`),f=!0),t.accumWidth=A}else{var T=P(r,c,t.width,t.breakAll,t.accumWidth);t.accumWidth=T.accumWidth+g,d=T.linesWidths,u=T.lines}}else u=r.split(`
`);for(var p=0;p<u.length;p++){var W=u[p],w=new y;if(w.styleName=n,w.text=W,w.isLineHolder=!W&&!h,typeof l.width=="number"?w.width=l.width:w.width=d?d[p]:m.getWidth(W,c),!p&&!f){var C=(e[e.length-1]||(e[0]=new N)).tokens,x=C.length;x===1&&C[0].isLineHolder?C[0]=w:(W||!x||h)&&C.push(w)}else e.push(new N([w]))}}o(D,"pushTokens");function rr(i){var r=i.charCodeAt(0);return r>=32&&r<=591||r>=880&&r<=4351||r>=4608&&r<=5119||r>=7680&&r<=8303}o(rr,"isAlphabeticLetter");var ir=H.reduce(",&?/;] ".split(""),function(i,r){return i[r]=!0,i},{});function er(i){return rr(i)?!!ir[i]:!0}o(er,"isWordBreakChar");function P(i,r,a,t,n){for(var h=[],l=[],e="",c="",f=0,u=0,d=0;d<i.length;d++){var s=i.charAt(d);if(s===`
`){c&&(e+=c,u+=f),h.push(e),l.push(u),e="",c="",f=0,u=0;continue}var g=m.getWidth(s,r),A=t?!1:!er(s);if(h.length?u+g>a:n+u+g>a){u?(e||c)&&(A?(e||(e=c,c="",f=0,u=f),h.push(e),l.push(u-f),c+=s,f+=g,e="",u=f):(c&&(e+=c,c="",f=0),h.push(e),l.push(u),e=s,u=g)):A?(h.push(c),l.push(f),c=s,f=g):(h.push(s),l.push(g));continue}u+=g,A?(c+=s,f+=g):(c&&(e+=c,c="",f=0),e+=s)}return!h.length&&!e&&(e=i,c="",f=0),c&&(e+=c),e&&(h.push(e),l.push(u)),h.length===1&&(u+=n),{accumWidth:u,lines:h,linesWidths:l}}o(P,"wrapText");exports.RichTextContentBlock=X;exports.parsePlainText=$;exports.parseRichText=k;exports.truncateText=Q;
