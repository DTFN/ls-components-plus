"use strict";var et=Object.defineProperty;var O=(e,a)=>et(e,"name",{value:a,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const at=require("../../../../../../tslib@2.3.0/node_modules/tslib/tslib.es6/index.cjs"),z=require("../helper/parseText/index.cjs"),j=require("../TSpan/index.cjs"),w=require("../../core/util/index.cjs"),D=require("../../contain/text/index.cjs"),it=require("../Image/index.cjs"),ot=require("../shape/Rect/index.cjs"),H=require("../../core/BoundingRect/index.cjs"),E=require("../Displayable/index.cjs"),P=require("../../core/platform/index.cjs");var q={fill:"#000"},I=2,K={style:w.defaults({fill:!0,stroke:!0,fillOpacity:!0,strokeOpacity:!0,lineWidth:!0,fontSize:!0,lineHeight:!0,width:!0,height:!0,textShadowColor:!0,textShadowBlur:!0,textShadowOffsetX:!0,textShadowOffsetY:!0,backgroundColor:!0,padding:!0,borderColor:!0,borderWidth:!0,borderRadius:!0},E.DEFAULT_COMMON_ANIMATION_PROPS.style)},J=function(e){at.__extends(a,e);function a(t){var r=e.call(this)||this;return r.type="text",r._children=[],r._defaultStyle=q,r.attr(t),r}return O(a,"ZRText"),a.prototype.childrenRef=function(){return this._children},a.prototype.update=function(){e.prototype.update.call(this),this.styleChanged()&&this._updateSubTexts();for(var t=0;t<this._children.length;t++){var r=this._children[t];r.zlevel=this.zlevel,r.z=this.z,r.z2=this.z2,r.culling=this.culling,r.cursor=this.cursor,r.invisible=this.invisible}},a.prototype.updateTransform=function(){var t=this.innerTransformable;t?(t.updateTransform(),t.transform&&(this.transform=t.transform)):e.prototype.updateTransform.call(this)},a.prototype.getLocalTransform=function(t){var r=this.innerTransformable;return r?r.getLocalTransform(t):e.prototype.getLocalTransform.call(this,t)},a.prototype.getComputedTransform=function(){return this.__hostTarget&&(this.__hostTarget.getComputedTransform(),this.__hostTarget.updateInnerText(!0)),e.prototype.getComputedTransform.call(this)},a.prototype._updateSubTexts=function(){this._childCursor=0,rt(this.style),this.style.rich?this._updateRichTexts():this._updatePlainTexts(),this._children.length=this._childCursor,this.styleUpdated()},a.prototype.addSelfToZr=function(t){e.prototype.addSelfToZr.call(this,t);for(var r=0;r<this._children.length;r++)this._children[r].__zr=t},a.prototype.removeSelfFromZr=function(t){e.prototype.removeSelfFromZr.call(this,t);for(var r=0;r<this._children.length;r++)this._children[r].__zr=null},a.prototype.getBoundingRect=function(){if(this.styleChanged()&&this._updateSubTexts(),!this._rect){for(var t=new H.default(0,0,0,0),r=this._children,o=[],n=null,h=0;h<r.length;h++){var g=r[h],p=g.getBoundingRect(),l=g.getLocalTransform(o);l?(t.copy(p),t.applyTransform(l),n=n||t.clone(),n.union(t)):(n=n||p.clone(),n.union(p))}this._rect=n||t}return this._rect},a.prototype.setDefaultTextStyle=function(t){this._defaultStyle=t||q},a.prototype.setTextContent=function(t){if(process.env.NODE_ENV!=="production")throw new Error("Can't attach text on another text")},a.prototype._mergeStyle=function(t,r){if(!r)return t;var o=r.rich,n=t.rich||o&&{};return w.extend(t,r),o&&n?(this._mergeRich(n,o),t.rich=n):n&&(t.rich=n),t},a.prototype._mergeRich=function(t,r){for(var o=w.keys(r),n=0;n<o.length;n++){var h=o[n];t[h]=t[h]||{},w.extend(t[h],r[h])}},a.prototype.getAnimationStyleProps=function(){return K},a.prototype._getOrCreateChild=function(t){var r=this._children[this._childCursor];return(!r||!(r instanceof t))&&(r=new t),this._children[this._childCursor++]=r,r.__zr=this.__zr,r.parent=this,r},a.prototype._updatePlainTexts=function(){var t=this.style,r=t.font||P.DEFAULT_FONT,o=t.padding,n=$(t),h=z.parsePlainText(n,t),g=X(t),p=!!t.backgroundColor,l=h.outerHeight,m=h.outerWidth,T=h.contentWidth,S=h.lines,F=h.lineHeight,x=this._defaultStyle,d=t.x||0,i=t.y||0,u=t.align||x.align||"left",s=t.verticalAlign||x.verticalAlign||"top",_=d,c=D.adjustTextY(i,h.contentHeight,s);if(g||o){var A=D.adjustTextX(d,m,u),W=D.adjustTextY(i,l,s);g&&this._renderBackground(t,t,A,W,m,l)}c+=F/2,o&&(_=G(d,u,o),s==="top"?c+=o[0]:s==="bottom"&&(c-=o[2]));for(var b=0,C=!1,R=V("fill"in t?t.fill:(C=!0,x.fill)),B=Z("stroke"in t?t.stroke:!p&&(!x.autoStroke||C)?(b=I,x.stroke):null),y=t.textShadowBlur>0,N=t.width!=null&&(t.overflow==="truncate"||t.overflow==="break"||t.overflow==="breakAll"),L=h.calculatedLineHeight,v=0;v<S.length;v++){var Y=this._getOrCreateChild(j.default),f=Y.createStyle();Y.useStyle(f),f.text=S[v],f.x=_,f.y=c,u&&(f.textAlign=u),f.textBaseline="middle",f.opacity=t.opacity,f.strokeFirst=!0,y&&(f.shadowBlur=t.textShadowBlur||0,f.shadowColor=t.textShadowColor||"transparent",f.shadowOffsetX=t.textShadowOffsetX||0,f.shadowOffsetY=t.textShadowOffsetY||0),f.stroke=B,f.fill=R,B&&(f.lineWidth=t.lineWidth||b,f.lineDash=t.lineDash,f.lineDashOffset=t.lineDashOffset||0),f.font=r,U(f,t),c+=F,N&&Y.setBoundingRect(new H.default(D.adjustTextX(f.x,t.width,f.textAlign),D.adjustTextY(f.y,L,f.textBaseline),T,L))}},a.prototype._updateRichTexts=function(){var t=this.style,r=$(t),o=z.parseRichText(r,t),n=o.width,h=o.outerWidth,g=o.outerHeight,p=t.padding,l=t.x||0,m=t.y||0,T=this._defaultStyle,S=t.align||T.align,F=t.verticalAlign||T.verticalAlign,x=D.adjustTextX(l,h,S),d=D.adjustTextY(m,g,F),i=x,u=d;p&&(i+=p[3],u+=p[0]);var s=i+n;X(t)&&this._renderBackground(t,t,x,d,h,g);for(var _=!!t.backgroundColor,c=0;c<o.lines.length;c++){for(var A=o.lines[c],W=A.tokens,b=W.length,C=A.lineHeight,R=A.width,B=0,y=i,N=s,L=b-1,v=void 0;B<b&&(v=W[B],!v.align||v.align==="left");)this._placeToken(v,t,C,u,y,"left",_),R-=v.width,y+=v.width,B++;for(;L>=0&&(v=W[L],v.align==="right");)this._placeToken(v,t,C,u,N,"right",_),R-=v.width,N-=v.width,L--;for(y+=(n-(y-i)-(s-N)-R)/2;B<=L;)v=W[B],this._placeToken(v,t,C,u,y+v.width/2,"center",_),y+=v.width,B++;u+=C}},a.prototype._placeToken=function(t,r,o,n,h,g,p){var l=r.rich[t.styleName]||{};l.text=t.text;var m=t.verticalAlign,T=n+o/2;m==="top"?T=n+t.height/2:m==="bottom"&&(T=n+o-t.height/2);var S=!t.isLineHolder&&X(l);S&&this._renderBackground(l,r,g==="right"?h-t.width:g==="center"?h-t.width/2:h,T-t.height/2,t.width,t.height);var F=!!l.backgroundColor,x=t.textPadding;x&&(h=G(h,g,x),T-=t.height/2-x[0]-t.innerHeight/2);var d=this._getOrCreateChild(j.default),i=d.createStyle();d.useStyle(i);var u=this._defaultStyle,s=!1,_=0,c=V("fill"in l?l.fill:"fill"in r?r.fill:(s=!0,u.fill)),A=Z("stroke"in l?l.stroke:"stroke"in r?r.stroke:!F&&!p&&(!u.autoStroke||s)?(_=I,u.stroke):null),W=l.textShadowBlur>0||r.textShadowBlur>0;i.text=t.text,i.x=h,i.y=T,W&&(i.shadowBlur=l.textShadowBlur||r.textShadowBlur||0,i.shadowColor=l.textShadowColor||r.textShadowColor||"transparent",i.shadowOffsetX=l.textShadowOffsetX||r.textShadowOffsetX||0,i.shadowOffsetY=l.textShadowOffsetY||r.textShadowOffsetY||0),i.textAlign=g,i.textBaseline="middle",i.font=t.font||P.DEFAULT_FONT,i.opacity=w.retrieve3(l.opacity,r.opacity,1),U(i,l),A&&(i.lineWidth=w.retrieve3(l.lineWidth,r.lineWidth,_),i.lineDash=w.retrieve2(l.lineDash,r.lineDash),i.lineDashOffset=r.lineDashOffset||0,i.stroke=A),c&&(i.fill=c);var b=t.contentWidth,C=t.contentHeight;d.setBoundingRect(new H.default(D.adjustTextX(i.x,b,i.textAlign),D.adjustTextY(i.y,C,i.textBaseline),b,C))},a.prototype._renderBackground=function(t,r,o,n,h,g){var p=t.backgroundColor,l=t.borderWidth,m=t.borderColor,T=p&&p.image,S=p&&!T,F=t.borderRadius,x=this,d,i;if(S||t.lineHeight||l&&m){d=this._getOrCreateChild(ot.default),d.useStyle(d.createStyle()),d.style.fill=null;var u=d.shape;u.x=o,u.y=n,u.width=h,u.height=g,u.r=F,d.dirtyShape()}if(S){var s=d.style;s.fill=p||null,s.fillOpacity=w.retrieve2(t.fillOpacity,1)}else if(T){i=this._getOrCreateChild(it.default),i.onload=function(){x.dirtyStyle()};var _=i.style;_.image=p.image,_.x=o,_.y=n,_.width=h,_.height=g}if(l&&m){var s=d.style;s.lineWidth=l,s.stroke=m,s.strokeOpacity=w.retrieve2(t.strokeOpacity,1),s.lineDash=t.borderDash,s.lineDashOffset=t.borderDashOffset||0,d.strokeContainThreshold=0,d.hasFill()&&d.hasStroke()&&(s.strokeFirst=!0,s.lineWidth*=2)}var c=(d||i).style;c.shadowBlur=t.shadowBlur||0,c.shadowColor=t.shadowColor||"transparent",c.shadowOffsetX=t.shadowOffsetX||0,c.shadowOffsetY=t.shadowOffsetY||0,c.opacity=w.retrieve3(t.opacity,r.opacity,1)},a.makeFont=function(t){var r="";return tt(t)&&(r=[t.fontStyle,t.fontWeight,Q(t.fontSize),t.fontFamily||"sans-serif"].join(" ")),r&&w.trim(r)||t.textFont||t.font},a}(E.default),nt={left:!0,right:1,center:1},ht={top:1,bottom:1,middle:1},k=["fontStyle","fontWeight","fontSize","fontFamily"];function Q(e){return typeof e=="string"&&(e.indexOf("px")!==-1||e.indexOf("rem")!==-1||e.indexOf("em")!==-1)?e:isNaN(+e)?P.DEFAULT_FONT_SIZE+"px":e+"px"}O(Q,"parseFontSize");function U(e,a){for(var t=0;t<k.length;t++){var r=k[t],o=a[r];o!=null&&(e[r]=o)}}O(U,"setSeparateFont");function tt(e){return e.fontSize!=null||e.fontFamily||e.fontWeight}O(tt,"hasSeparateFont");function rt(e){return M(e),w.each(e.rich,M),e}O(rt,"normalizeTextStyle");function M(e){if(e){e.font=J.makeFont(e);var a=e.align;a==="middle"&&(a="center"),e.align=a==null||nt[a]?a:"left";var t=e.verticalAlign;t==="center"&&(t="middle"),e.verticalAlign=t==null||ht[t]?t:"top";var r=e.padding;r&&(e.padding=w.normalizeCssArray(e.padding))}}O(M,"normalizeStyle");function Z(e,a){return e==null||a<=0||e==="transparent"||e==="none"?null:e.image||e.colorStops?"#000":e}O(Z,"getStroke");function V(e){return e==null||e==="none"?null:e.image||e.colorStops?"#000":e}O(V,"getFill");function G(e,a,t){return a==="right"?e-t[1]:a==="center"?e+t[3]/2-t[1]/2:e+t[3]}O(G,"getTextXForPadding");function $(e){var a=e.text;return a!=null&&(a+=""),a}O($,"getStyleText");function X(e){return!!(e.backgroundColor||e.lineHeight||e.borderWidth&&e.borderColor)}O(X,"needDrawBackground");exports.DEFAULT_TEXT_ANIMATION_PROPS=K;exports.default=J;exports.hasSeparateFont=tt;exports.normalizeTextStyle=rt;exports.parseFontSize=Q;
