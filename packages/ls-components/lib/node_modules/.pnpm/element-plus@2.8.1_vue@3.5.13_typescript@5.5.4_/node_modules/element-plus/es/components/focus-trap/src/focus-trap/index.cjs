"use strict";var D=Object.defineProperty;var d=(n,a)=>D(n,"name",{value:a,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const o=require("vue"),s=require("../utils/index.cjs"),r=require("../tokens/index.cjs"),k=require("../../../../_virtual/plugin-vue_export-helper/index.cjs"),q=require("../../../../hooks/use-escape-keydown/index/index.cjs"),K=require("../../../../constants/aria/index.cjs"),w=require("../../../../../../../../@vue_shared@3.5.13/node_modules/@vue/shared/dist/shared.esm-bundler/index.cjs"),I=require("../../../../../../../../lodash-es@4.17.21/node_modules/lodash-es/isNil/index.cjs"),N=o.defineComponent({name:"ElFocusTrap",inheritAttrs:!1,props:{loop:Boolean,trapped:Boolean,focusTrapEl:Object,focusStartEl:{type:[Object,String],default:"first"}},emits:[r.ON_TRAP_FOCUS_EVT,r.ON_RELEASE_FOCUS_EVT,"focusin","focusout","focusout-prevented","release-requested"],setup(n,{emit:a}){const u=o.ref();let p,T;const{focusReason:v}=s.useFocusReason();q.useEscapeKeydown(e=>{n.trapped&&!E.paused&&a("release-requested",e)});const E={paused:!1,pause(){this.paused=!0},resume(){this.paused=!1}},F=d(e=>{if(!n.loop&&!n.trapped||E.paused)return;const{key:t,altKey:c,ctrlKey:i,metaKey:f,currentTarget:L,shiftKey:g}=e,{loop:U}=n,h=t===K.EVENT_CODE.tab&&!c&&!i&&!f,_=document.activeElement;if(h&&_){const S=L,[m,y]=s.getEdges(S);if(m&&y){if(!g&&_===y){const l=s.createFocusOutPreventedEvent({focusReason:v.value});a("focusout-prevented",l),l.defaultPrevented||(e.preventDefault(),U&&s.tryFocus(m,!0))}else if(g&&[m,S].includes(_)){const l=s.createFocusOutPreventedEvent({focusReason:v.value});a("focusout-prevented",l),l.defaultPrevented||(e.preventDefault(),U&&s.tryFocus(y,!0))}}else if(_===S){const l=s.createFocusOutPreventedEvent({focusReason:v.value});a("focusout-prevented",l),l.defaultPrevented||e.preventDefault()}}},"onKeydown");o.provide(r.FOCUS_TRAP_INJECTION_KEY,{focusTrapRef:u,onKeydown:F}),o.watch(()=>n.focusTrapEl,e=>{e&&(u.value=e)},{immediate:!0}),o.watch([u],([e],[t])=>{e&&(e.addEventListener("keydown",F),e.addEventListener("focusin",P),e.addEventListener("focusout",O)),t&&(t.removeEventListener("keydown",F),t.removeEventListener("focusin",P),t.removeEventListener("focusout",O))});const A=d(e=>{a(r.ON_TRAP_FOCUS_EVT,e)},"trapOnFocus"),C=d(e=>a(r.ON_RELEASE_FOCUS_EVT,e),"releaseOnFocus"),P=d(e=>{const t=o.unref(u);if(!t)return;const c=e.target,i=e.relatedTarget,f=c&&t.contains(c);n.trapped||i&&t.contains(i)||(p=i),f&&a("focusin",e),!E.paused&&n.trapped&&(f?T=c:s.tryFocus(T,!0))},"onFocusIn"),O=d(e=>{const t=o.unref(u);if(!(E.paused||!t))if(n.trapped){const c=e.relatedTarget;!I.default(c)&&!t.contains(c)&&setTimeout(()=>{if(!E.paused&&n.trapped){const i=s.createFocusOutPreventedEvent({focusReason:v.value});a("focusout-prevented",i),i.defaultPrevented||s.tryFocus(T,!0)}},0)}else{const c=e.target;c&&t.contains(c)||a("focusout",e)}},"onFocusOut");async function R(){await o.nextTick();const e=o.unref(u);if(e){s.focusableStack.push(E);const t=e.contains(document.activeElement)?p:document.activeElement;if(p=t,!e.contains(t)){const i=new Event(r.FOCUS_AFTER_TRAPPED,r.FOCUS_AFTER_TRAPPED_OPTS);e.addEventListener(r.FOCUS_AFTER_TRAPPED,A),e.dispatchEvent(i),i.defaultPrevented||o.nextTick(()=>{let f=n.focusStartEl;w.isString(f)||(s.tryFocus(f),document.activeElement!==f&&(f="first")),f==="first"&&s.focusFirstDescendant(s.obtainAllFocusableElements(e),!0),(document.activeElement===t||f==="container")&&s.tryFocus(e)})}}}d(R,"startTrap");function b(){const e=o.unref(u);if(e){e.removeEventListener(r.FOCUS_AFTER_TRAPPED,A);const t=new CustomEvent(r.FOCUS_AFTER_RELEASED,{...r.FOCUS_AFTER_TRAPPED_OPTS,detail:{focusReason:v.value}});e.addEventListener(r.FOCUS_AFTER_RELEASED,C),e.dispatchEvent(t),!t.defaultPrevented&&(v.value=="keyboard"||!s.isFocusCausedByUserEvent()||e.contains(document.activeElement))&&s.tryFocus(p??document.body),e.removeEventListener(r.FOCUS_AFTER_RELEASED,C),s.focusableStack.remove(E)}}return d(b,"stopTrap"),o.onMounted(()=>{n.trapped&&R(),o.watch(()=>n.trapped,e=>{e?R():b()})}),o.onBeforeUnmount(()=>{n.trapped&&b(),u.value&&(u.value.removeEventListener("keydown",F),u.value.removeEventListener("focusin",P),u.value.removeEventListener("focusout",O),u.value=void 0)}),{onKeydown:F}}});function B(n,a,u,p,T,v){return o.renderSlot(n.$slots,"default",{handleKeydown:n.onKeydown})}d(B,"_sfc_render");var V=k.default(N,[["render",B],["__file","focus-trap.vue"]]);exports.default=V;
