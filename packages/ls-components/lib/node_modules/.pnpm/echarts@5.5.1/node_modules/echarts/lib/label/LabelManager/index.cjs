"use strict";var G=Object.defineProperty;var y=(l,a)=>G(l,"name",{value:a,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});require("../../util/graphic/index.cjs");const P=require("../../util/innerStore/index.cjs"),R=require("../../util/number/index.cjs"),H=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/Transformable/index.cjs"),T=require("../labelGuideHelper/index.cjs"),X=require("../../util/model/index.cjs"),g=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/util/index.cjs"),m=require("../labelLayoutHelper/index.cjs"),Y=require("../labelStyle/index.cjs"),B=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/contain/util/index.cjs"),A=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/BoundingRect/index.cjs"),x=require("../../animation/basicTransition/index.cjs");function z(l){if(l){for(var a=[],n=0;n<l.length;n++)a.push(l[n].slice());return a}}y(z,"cloneArr");function N(l,a){var n=l.label,e=a&&a.getTextGuideLine();return{dataIndex:l.dataIndex,dataType:l.dataType,seriesIndex:l.seriesModel.seriesIndex,text:l.label.style.text,rect:l.hostRect,labelRect:l.rect,align:n.style.align,verticalAlign:n.style.verticalAlign,labelLinePoints:z(e&&e.shape.points)}}y(N,"prepareLayoutCallbackParams");var E=["align","verticalAlign","width","height","fontSize"],c=new H.default,C=X.makeInner(),j=X.makeInner();function b(l,a,n){for(var e=0;e<n.length;e++){var r=n[e];a[r]!=null&&(l[r]=a[r])}}y(b,"extendWithKeys");var S=["x","y","rotation"],U=function(){function l(){this._labelList=[],this._chartViewList=[]}return y(l,"LabelManager"),l.prototype.clearLabels=function(){this._labelList=[],this._chartViewList=[]},l.prototype._addLabel=function(a,n,e,r,o){var t=r.style,i=r.__hostTarget,u=i.textConfig||{},v=r.getComputedTransform(),s=r.getBoundingRect().plain();A.default.applyTransform(s,s,v),v?c.setLocalTransform(v):(c.x=c.y=c.rotation=c.originX=c.originY=0,c.scaleX=c.scaleY=1),c.rotation=B.normalizeRadian(c.rotation);var f=r.__hostTarget,d;if(f){d=f.getBoundingRect().plain();var p=f.getComputedTransform();A.default.applyTransform(d,d,p)}var L=d&&f.getTextGuideLine();this._labelList.push({label:r,labelLine:L,seriesModel:e,dataIndex:a,dataType:n,layoutOption:o,computedLayoutOption:null,rect:s,hostRect:d,priority:d?d.width*d.height:0,defaultAttr:{ignore:r.ignore,labelGuideIgnore:L&&L.ignore,x:c.x,y:c.y,scaleX:c.scaleX,scaleY:c.scaleY,rotation:c.rotation,style:{x:t.x,y:t.y,align:t.align,verticalAlign:t.verticalAlign,width:t.width,height:t.height,fontSize:t.fontSize},cursor:r.cursor,attachedPos:u.position,attachedRot:u.rotation}})},l.prototype.addLabelsOfSeries=function(a){var n=this;this._chartViewList.push(a);var e=a.__model,r=e.get("labelLayout");(g.isFunction(r)||g.keys(r).length)&&a.group.traverse(function(o){if(o.ignore)return!0;var t=o.getTextContent(),i=P.getECData(o);t&&!t.disableLabelLayout&&n._addLabel(i.dataIndex,i.dataType,e,t,r)})},l.prototype.updateLayoutConfig=function(a){var n=a.getWidth(),e=a.getHeight();function r(M,O){return function(){T.updateLabelLinePoints(M,O)}}y(r,"createDragHandler");for(var o=0;o<this._labelList.length;o++){var t=this._labelList[o],i=t.label,u=i.__hostTarget,v=t.defaultAttr,s=void 0;g.isFunction(t.layoutOption)?s=t.layoutOption(N(t,u)):s=t.layoutOption,s=s||{},t.computedLayoutOption=s;var f=Math.PI/180;u&&u.setTextConfig({local:!1,position:s.x!=null||s.y!=null?null:v.attachedPos,rotation:s.rotate!=null?s.rotate*f:v.attachedRot,offset:[s.dx||0,s.dy||0]});var d=!1;if(s.x!=null?(i.x=R.parsePercent(s.x,n),i.setStyle("x",0),d=!0):(i.x=v.x,i.setStyle("x",v.style.x)),s.y!=null?(i.y=R.parsePercent(s.y,e),i.setStyle("y",0),d=!0):(i.y=v.y,i.setStyle("y",v.style.y)),s.labelLinePoints){var p=u.getTextGuideLine();p&&(p.setShape({points:s.labelLinePoints}),d=!1)}var L=C(i);L.needsUpdateLabelLine=d,i.rotation=s.rotate!=null?s.rotate*f:v.rotation,i.scaleX=v.scaleX,i.scaleY=v.scaleY;for(var h=0;h<E.length;h++){var _=E[h];i.setStyle(_,s[_]!=null?s[_]:v.style[_])}if(s.draggable){if(i.draggable=!0,i.cursor="move",u){var q=t.seriesModel;if(t.dataIndex!=null){var D=t.seriesModel.getData(t.dataType);q=D.getItemModel(t.dataIndex)}i.on("drag",r(u,q.getModel("labelLine")))}}else i.off("drag"),i.cursor=v.cursor}},l.prototype.layout=function(a){var n=a.getWidth(),e=a.getHeight(),r=m.prepareLayoutList(this._labelList),o=g.filter(r,function(u){return u.layoutOption.moveOverlap==="shiftX"}),t=g.filter(r,function(u){return u.layoutOption.moveOverlap==="shiftY"});m.shiftLayoutOnX(o,0,n),m.shiftLayoutOnY(t,0,e);var i=g.filter(r,function(u){return u.layoutOption.hideOverlap});m.hideOverlap(i)},l.prototype.processLabelsOverall=function(){var a=this;g.each(this._chartViewList,function(n){var e=n.__model,r=n.ignoreLabelLineUpdate,o=e.isAnimationEnabled();n.group.traverse(function(t){if(t.ignore&&!t.forceLabelAnimation)return!0;var i=!r,u=t.getTextContent();!i&&u&&(i=C(u).needsUpdateLabelLine),i&&a._updateLabelLine(t,e),o&&a._animateLabels(t,e)})})},l.prototype._updateLabelLine=function(a,n){var e=a.getTextContent(),r=P.getECData(a),o=r.dataIndex;if(e&&o!=null){var t=n.getData(r.dataType),i=t.getItemModel(o),u={},v=t.getItemVisual(o,"style");if(v){var s=t.getVisual("drawType");u.stroke=v[s]}var f=i.getModel("labelLine");T.setLabelLineStyle(a,T.getLabelLineStatesModels(i),u),T.updateLabelLinePoints(a,f)}},l.prototype._animateLabels=function(a,n){var e=a.getTextContent(),r=a.getTextGuideLine();if(e&&(a.forceLabelAnimation||!e.ignore&&!e.invisible&&!a.disableLabelAnimation&&!x.isElementRemoved(a))){var o=C(e),t=o.oldLayout,i=P.getECData(a),u=i.dataIndex,v={x:e.x,y:e.y,rotation:e.rotation},s=n.getData(i.dataType);if(t){e.attr(t);var d=a.prevStates;d&&(g.indexOf(d,"select")>=0&&e.attr(o.oldLayoutSelect),g.indexOf(d,"emphasis")>=0&&e.attr(o.oldLayoutEmphasis)),x.updateProps(e,v,n,u)}else if(e.attr(v),!Y.labelInner(e).valueAnimation){var f=g.retrieve2(e.style.opacity,1);e.style.opacity=0,x.initProps(e,{style:{opacity:f}},n,u)}if(o.oldLayout=v,e.states.select){var p=o.oldLayoutSelect={};b(p,v,S),b(p,e.states.select,S)}if(e.states.emphasis){var L=o.oldLayoutEmphasis={};b(L,v,S),b(L,e.states.emphasis,S)}Y.animateLabelValue(e,u,s,n,n)}if(r&&!r.ignore&&!r.invisible){var o=j(r),t=o.oldLayout,h={points:r.shape.points};t?(r.attr({shape:t}),x.updateProps(r,{shape:h},n)):(r.setShape(h),r.style.strokePercent=0,x.initProps(r,{style:{strokePercent:1}},n)),o.oldLayout=h}},l}();exports.default=U;
