"use strict";var j=Object.defineProperty;var M=(h,a)=>j(h,"name",{value:a,configurable:!0});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const G=require("../../../../../../../tslib@2.3.0/node_modules/tslib/tslib.es6/index.cjs"),c=require("../../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/util/index.cjs"),A=require("../../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/env/index.cjs"),Q=require("../TooltipHTMLContent/index.cjs"),Z=require("../TooltipRichContent/index.cjs"),O=require("../../../util/format/index.cjs"),z=require("../../../util/number/index.cjs");require("../../../util/graphic/index.cjs");const $=require("../../axisPointer/findPointFromSeries/index.cjs"),J=require("../../../util/layout/index.cjs"),P=require("../../../model/Model/index.cjs"),V=require("../../axisPointer/globalListener/index.cjs"),K=require("../../../coord/axisHelper/index.cjs"),E=require("../../axisPointer/viewHelper/index.cjs"),X=require("../../../util/model/index.cjs"),ee=require("../../../view/Component/index.cjs"),te=require("../../../util/time/index.cjs"),k=require("../../../util/innerStore/index.cjs"),ie=require("../helper/index.cjs"),N=require("../../../model/mixin/dataFormat/index.cjs"),b=require("../tooltipMarkup/index.cjs"),oe=require("../../../util/event/index.cjs"),H=require("../../../util/throttle/index.cjs"),re=require("../../../../../../../zrender@5.6.0/node_modules/zrender/lib/graphic/shape/Rect/index.cjs"),ne=require("../../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/dom/index.cjs");var ae=new re.default({shape:{x:-1,y:-1,width:2,height:2}}),se=function(h){G.__extends(a,h);function a(){var o=h!==null&&h.apply(this,arguments)||this;return o.type=a.type,o}return M(a,"TooltipView"),a.prototype.init=function(o,r){if(!(A.default.node||!r.getDom())){var t=o.getComponent("tooltip"),e=this._renderMode=X.getTooltipRenderMode(t.get("renderMode"));this._tooltipContent=e==="richText"?new Z.default(r):new Q.default(r,{appendTo:t.get("appendToBody",!0)?"body":t.get("appendTo",!0)})}},a.prototype.render=function(o,r,t){if(!(A.default.node||!t.getDom())){this.group.removeAll(),this._tooltipModel=o,this._ecModel=r,this._api=t;var e=this._tooltipContent;e.update(o),e.setEnterable(o.get("enterable")),this._initGlobalListener(),this._keepShow(),this._renderMode!=="richText"&&o.get("transitionDuration")?H.createOrUpdate(this,"_updatePosition",50,"fixRate"):H.clear(this,"_updatePosition")}},a.prototype._initGlobalListener=function(){var o=this._tooltipModel,r=o.get("triggerOn");V.register("itemTooltip",this._api,c.bind(function(t,e,i){r!=="none"&&(r.indexOf(t)>=0?this._tryShow(e,i):t==="leave"&&this._hide(i))},this))},a.prototype._keepShow=function(){var o=this._tooltipModel,r=this._ecModel,t=this._api,e=o.get("triggerOn");if(this._lastX!=null&&this._lastY!=null&&e!=="none"&&e!=="click"){var i=this;clearTimeout(this._refreshUpdateTimeout),this._refreshUpdateTimeout=setTimeout(function(){!t.isDisposed()&&i.manuallyShowTip(o,r,t,{x:i._lastX,y:i._lastY,dataByCoordSys:i._lastDataByCoordSys})})}},a.prototype.manuallyShowTip=function(o,r,t,e){if(!(e.from===this.uid||A.default.node||!t.getDom())){var i=U(e,t);this._ticket="";var u=e.dataByCoordSys,n=fe(e,r,t);if(n){var s=n.el.getBoundingRect().clone();s.applyTransform(n.el.transform),this._tryShow({offsetX:s.x+s.width/2,offsetY:s.y+s.height/2,target:n.el,position:e.position,positionDefault:"bottom"},i)}else if(e.tooltip&&e.x!=null&&e.y!=null){var l=ae;l.x=e.x,l.y=e.y,l.update(),k.getECData(l).tooltipConfig={name:null,option:e.tooltip},this._tryShow({offsetX:e.x,offsetY:e.y,target:l},i)}else if(u)this._tryShow({offsetX:e.x,offsetY:e.y,position:e.position,dataByCoordSys:u,tooltipOption:e.tooltipOption},i);else if(e.seriesIndex!=null){if(this._manuallyAxisShowTip(o,r,t,e))return;var d=$.default(e,r),f=d.point[0],v=d.point[1];f!=null&&v!=null&&this._tryShow({offsetX:f,offsetY:v,target:d.el,position:e.position,positionDefault:"bottom"},i)}else e.x!=null&&e.y!=null&&(t.dispatchAction({type:"updateAxisPointer",x:e.x,y:e.y}),this._tryShow({offsetX:e.x,offsetY:e.y,position:e.position,target:t.getZr().findHover(e.x,e.y).target},i))}},a.prototype.manuallyHideTip=function(o,r,t,e){var i=this._tooltipContent;this._tooltipModel&&i.hideLater(this._tooltipModel.get("hideDelay")),this._lastX=this._lastY=this._lastDataByCoordSys=null,e.from!==this.uid&&this._hide(U(e,t))},a.prototype._manuallyAxisShowTip=function(o,r,t,e){var i=e.seriesIndex,u=e.dataIndex,n=r.getComponent("axisPointer").coordSysAxesInfo;if(!(i==null||u==null||n==null)){var s=r.getSeriesByIndex(i);if(s){var l=s.getData(),d=I([l.getItemModel(u),s,(s.coordinateSystem||{}).model],this._tooltipModel);if(d.get("trigger")==="axis")return t.dispatchAction({type:"updateAxisPointer",seriesIndex:i,dataIndex:u,position:e.position}),!0}}},a.prototype._tryShow=function(o,r){var t=o.target,e=this._tooltipModel;if(e){this._lastX=o.offsetX,this._lastY=o.offsetY;var i=o.dataByCoordSys;if(i&&i.length)this._showAxisTooltip(i,o);else if(t){var u=k.getECData(t);if(u.ssrType==="legend")return;this._lastDataByCoordSys=null;var n,s;oe.findEventDispatcher(t,function(l){if(k.getECData(l).dataIndex!=null)return n=l,!0;if(k.getECData(l).tooltipConfig!=null)return s=l,!0},!0),n?this._showSeriesItemTooltip(o,n,r):s?this._showComponentItemTooltip(o,s,r):this._hide(r)}else this._lastDataByCoordSys=null,this._hide(r)}},a.prototype._showOrMove=function(o,r){var t=o.get("showDelay");r=c.bind(r,this),clearTimeout(this._showTimout),t>0?this._showTimout=setTimeout(r,t):r()},a.prototype._showAxisTooltip=function(o,r){var t=this._ecModel,e=this._tooltipModel,i=[r.offsetX,r.offsetY],u=I([r.tooltipOption],e),n=this._renderMode,s=[],l=b.createTooltipMarkup("section",{blocks:[],noHeader:!0}),d=[],f=new b.TooltipMarkupStyleCreator;c.each(o,function(y){c.each(y.dataByAxis,function(m){var x=t.getComponent(m.axisDim+"Axis",m.axisIndex),w=m.value;if(!(!x||w==null)){var S=E.getValueLabel(w,x.axis,t,m.seriesDataIndices,m.valueLabelOpt),D=b.createTooltipMarkup("section",{header:S,noHeader:!c.trim(S),sortBlocks:!0,blocks:[]});l.blocks.push(D),c.each(m.seriesDataIndices,function(q){var B=t.getSeriesByIndex(q.seriesIndex),Y=q.dataIndexInside,C=B.getDataParams(Y);if(!(C.dataIndex<0)){C.axisDim=m.axisDim,C.axisIndex=m.axisIndex,C.axisType=m.axisType,C.axisId=m.axisId,C.axisValue=K.getAxisRawValue(x.axis,{value:w}),C.axisValueLabel=S,C.marker=f.makeTooltipMarker("item",O.convertToColorString(C.color),n);var R=N.normalizeTooltipFormatResult(B.formatTooltip(Y,!0,null)),L=R.frag;if(L){var F=I([B],e).get("valueFormatter");D.blocks.push(F?c.extend({valueFormatter:F},L):L)}R.text&&d.push(R.text),s.push(C)}})}})}),l.blocks.reverse(),d.reverse();var v=r.position,_=u.get("order"),p=b.buildTooltipMarkup(l,f,n,_,t.get("useUTC"),u.get("textStyle"));p&&d.unshift(p);var T=n==="richText"?`

`:"<br/>",g=d.join(T);this._showOrMove(u,function(){this._updateContentNotChangedOnAxis(o,s)?this._updatePosition(u,v,i[0],i[1],this._tooltipContent,s):this._showTooltipContent(u,g,s,Math.random()+"",i[0],i[1],v,null,f)})},a.prototype._showSeriesItemTooltip=function(o,r,t){var e=this._ecModel,i=k.getECData(r),u=i.seriesIndex,n=e.getSeriesByIndex(u),s=i.dataModel||n,l=i.dataIndex,d=i.dataType,f=s.getData(d),v=this._renderMode,_=o.positionDefault,p=I([f.getItemModel(l),s,n&&(n.coordinateSystem||{}).model],this._tooltipModel,_?{position:_}:null),T=p.get("trigger");if(!(T!=null&&T!=="item")){var g=s.getDataParams(l,d),y=new b.TooltipMarkupStyleCreator;g.marker=y.makeTooltipMarker("item",O.convertToColorString(g.color),v);var m=N.normalizeTooltipFormatResult(s.formatTooltip(l,!1,d)),x=p.get("order"),w=p.get("valueFormatter"),S=m.frag,D=S?b.buildTooltipMarkup(w?c.extend({valueFormatter:w},S):S,y,v,x,e.get("useUTC"),p.get("textStyle")):m.text,q="item_"+s.name+"_"+l;this._showOrMove(p,function(){this._showTooltipContent(p,D,g,q,o.offsetX,o.offsetY,o.position,o.target,y)}),t({type:"showTip",dataIndexInside:l,dataIndex:f.getRawIndex(l),seriesIndex:u,from:this.uid})}},a.prototype._showComponentItemTooltip=function(o,r,t){var e=this._renderMode==="html",i=k.getECData(r),u=i.tooltipConfig,n=u.option||{},s=n.encodeHTMLContent;if(c.isString(n)){var l=n;n={content:l,formatter:l},s=!0}s&&e&&n.content&&(n=c.clone(n),n.content=ne.encodeHTML(n.content));var d=[n],f=this._ecModel.getComponent(i.componentMainType,i.componentIndex);f&&d.push(f),d.push({formatter:n.content});var v=o.positionDefault,_=I(d,this._tooltipModel,v?{position:v}:null),p=_.get("content"),T=Math.random()+"",g=new b.TooltipMarkupStyleCreator;this._showOrMove(_,function(){var y=c.clone(_.get("formatterParams")||{});this._showTooltipContent(_,p,y,T,o.offsetX,o.offsetY,o.position,r,g)}),t({type:"showTip",from:this.uid})},a.prototype._showTooltipContent=function(o,r,t,e,i,u,n,s,l){if(this._ticket="",!(!o.get("showContent")||!o.get("show"))){var d=this._tooltipContent;d.setEnterable(o.get("enterable"));var f=o.get("formatter");n=n||o.get("position");var v=r,_=this._getNearestPoint([i,u],t,o.get("trigger"),o.get("borderColor")),p=_.color;if(f)if(c.isString(f)){var T=o.ecModel.get("useUTC"),g=c.isArray(t)?t[0]:t,y=g&&g.axisType&&g.axisType.indexOf("time")>=0;v=f,y&&(v=te.format(g.axisValue,v,T)),v=O.formatTpl(v,t,!0)}else if(c.isFunction(f)){var m=c.bind(function(x,w){x===this._ticket&&(d.setContent(w,l,o,p,n),this._updatePosition(o,n,i,u,d,t,s))},this);this._ticket=e,v=f(t,e,m)}else v=f;d.setContent(v,l,o,p,n),d.show(o,p),this._updatePosition(o,n,i,u,d,t,s)}},a.prototype._getNearestPoint=function(o,r,t,e){if(t==="axis"||c.isArray(r))return{color:e||(this._renderMode==="html"?"#fff":"none")};if(!c.isArray(r))return{color:e||r.color||r.borderColor}},a.prototype._updatePosition=function(o,r,t,e,i,u,n){var s=this._api.getWidth(),l=this._api.getHeight();r=r||o.get("position");var d=i.getSize(),f=o.get("align"),v=o.get("verticalAlign"),_=n&&n.getBoundingRect().clone();if(n&&_.applyTransform(n.transform),c.isFunction(r)&&(r=r([t,e],u,i.el,_,{viewSize:[s,l],contentSize:d.slice()})),c.isArray(r))t=z.parsePercent(r[0],s),e=z.parsePercent(r[1],l);else if(c.isObject(r)){var p=r;p.width=d[0],p.height=d[1];var T=J.getLayoutRect(p,{width:s,height:l});t=T.x,e=T.y,f=null,v=null}else if(c.isString(r)&&n){var g=de(r,_,d,o.get("borderWidth"));t=g[0],e=g[1]}else{var g=le(t,e,i,s,l,f?null:20,v?null:20);t=g[0],e=g[1]}if(f&&(t-=W(f)?d[0]/2:f==="right"?d[0]:0),v&&(e-=W(v)?d[1]/2:v==="bottom"?d[1]:0),ie.shouldTooltipConfine(o)){var g=ue(t,e,i,s,l);t=g[0],e=g[1]}i.moveTo(t,e)},a.prototype._updateContentNotChangedOnAxis=function(o,r){var t=this._lastDataByCoordSys,e=this._cbParamsList,i=!!t&&t.length===o.length;return i&&c.each(t,function(u,n){var s=u.dataByAxis||[],l=o[n]||{},d=l.dataByAxis||[];i=i&&s.length===d.length,i&&c.each(s,function(f,v){var _=d[v]||{},p=f.seriesDataIndices||[],T=_.seriesDataIndices||[];i=i&&f.value===_.value&&f.axisType===_.axisType&&f.axisId===_.axisId&&p.length===T.length,i&&c.each(p,function(g,y){var m=T[y];i=i&&g.seriesIndex===m.seriesIndex&&g.dataIndex===m.dataIndex}),e&&c.each(f.seriesDataIndices,function(g){var y=g.seriesIndex,m=r[y],x=e[y];m&&x&&x.data!==m.data&&(i=!1)})})}),this._lastDataByCoordSys=o,this._cbParamsList=r,!!i},a.prototype._hide=function(o){this._lastDataByCoordSys=null,o({type:"hideTip",from:this.uid})},a.prototype.dispose=function(o,r){A.default.node||!r.getDom()||(H.clear(this,"_updatePosition"),this._tooltipContent.dispose(),V.unregister("itemTooltip",r))},a.type="tooltip",a}(ee.default);function I(h,a,o){var r=a.ecModel,t;o?(t=new P.default(o,r,r),t=new P.default(a.option,t,r)):t=a;for(var e=h.length-1;e>=0;e--){var i=h[e];i&&(i instanceof P.default&&(i=i.get("tooltip",!0)),c.isString(i)&&(i={formatter:i}),i&&(t=new P.default(i,t,r)))}return t}M(I,"buildTooltipModel");function U(h,a){return h.dispatchAction||c.bind(a.dispatchAction,a)}M(U,"makeDispatchAction");function le(h,a,o,r,t,e,i){var u=o.getSize(),n=u[0],s=u[1];return e!=null&&(h+n+e+2>r?h-=n+e:h+=e),i!=null&&(a+s+i>t?a-=s+i:a+=i),[h,a]}M(le,"refixTooltipPosition");function ue(h,a,o,r,t){var e=o.getSize(),i=e[0],u=e[1];return h=Math.min(h+i,r)-i,a=Math.min(a+u,t)-u,h=Math.max(h,0),a=Math.max(a,0),[h,a]}M(ue,"confineTooltipPosition");function de(h,a,o,r){var t=o[0],e=o[1],i=Math.ceil(Math.SQRT2*r)+8,u=0,n=0,s=a.width,l=a.height;switch(h){case"inside":u=a.x+s/2-t/2,n=a.y+l/2-e/2;break;case"top":u=a.x+s/2-t/2,n=a.y-e-i;break;case"bottom":u=a.x+s/2-t/2,n=a.y+l+i;break;case"left":u=a.x-t-i,n=a.y+l/2-e/2;break;case"right":u=a.x+s+i,n=a.y+l/2-e/2}return[u,n]}M(de,"calcTooltipPosition");function W(h){return h==="center"||h==="middle"}M(W,"isCenterAlign");function fe(h,a,o){var r=X.preParseFinder(h).queryOptionMap,t=r.keys()[0];if(!(!t||t==="series")){var e=X.queryReferringComponents(a,t,r.get(t),{useDefault:!1,enableAll:!1,enableNone:!1}),i=e.models[0];if(i){var u=o.getViewOfComponentModel(i),n;if(u.group.traverse(function(s){var l=k.getECData(s).tooltipConfig;if(l&&l.name===h.name)return n=s,!0}),n)return{componentMainType:t,componentIndex:i.componentIndex,el:n}}}}M(fe,"findComponentReference");exports.default=se;
