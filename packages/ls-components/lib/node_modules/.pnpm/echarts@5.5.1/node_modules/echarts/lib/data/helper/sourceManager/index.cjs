"use strict";var N=Object.defineProperty;var p=(s,e)=>N(s,"name",{value:e,configurable:!0});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const v=require("../../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/util/index.cjs"),S=require("../../Source/index.cjs"),L=require("../../../util/types/index.cjs"),D=require("../sourceHelper/index.cjs"),U=require("../transform/index.cjs"),O=require("../../DataStore/index.cjs"),V=require("../dataProvider/index.cjs");var q=function(){function s(e){this._sourceList=[],this._storeList=[],this._upstreamSignList=[],this._versionSignBase=0,this._dirty=!0,this._sourceHost=e}return p(s,"SourceManager"),s.prototype.dirty=function(){this._setLocalSource([],[]),this._storeList=[],this._dirty=!0},s.prototype._setLocalSource=function(e,r){this._sourceList=e,this._upstreamSignList=r,this._versionSignBase++,this._versionSignBase>9e10&&(this._versionSignBase=0)},s.prototype._getVersionSign=function(){return this._sourceHost.uid+"_"+this._versionSignBase},s.prototype.prepareSource=function(){this._isDirty()&&(this._createSource(),this._dirty=!1)},s.prototype._createSource=function(){this._setLocalSource([],[]);var e=this._sourceHost,r=this._getUpstreamSourceManagers(),t=!!r.length,o,i;if(g(e)){var n=e,a=void 0,u=void 0,c=void 0;if(t){var _=r[0];_.prepareSource(),c=_.getSource(),a=c.data,u=c.sourceFormat,i=[_._getVersionSign()]}else a=n.get("data",!0),u=v.isTypedArray(a)?L.SOURCE_FORMAT_TYPED_ARRAY:L.SOURCE_FORMAT_ORIGINAL,i=[];var h=this._getSourceMetaRawOption()||{},f=c&&c.metaRawOption||{},l=v.retrieve2(h.seriesLayoutBy,f.seriesLayoutBy)||null,y=v.retrieve2(h.sourceHeader,f.sourceHeader),m=v.retrieve2(h.dimensions,f.dimensions),E=l!==f.seriesLayoutBy||!!y!=!!f.sourceHeader||m;o=E?[S.createSource(a,{seriesLayoutBy:l,sourceHeader:y,dimensions:m},u)]:[]}else{var T=e;if(t){var d=this._applyTransform(r);o=d.sourceList,i=d.upstreamSignList}else{var B=T.get("source",!0);o=[S.createSource(B,this._getSourceMetaRawOption(),null)],i=[]}}process.env.NODE_ENV!=="production"&&v.assert(o&&i),this._setLocalSource(o,i)},s.prototype._applyTransform=function(e){var r=this._sourceHost,t=r.get("transform",!0),o=r.get("fromTransformResult",!0);if(process.env.NODE_ENV!=="production"&&v.assert(o!=null||t!=null),o!=null){var i="";e.length!==1&&(process.env.NODE_ENV!=="production"&&(i="When using `fromTransformResult`, there should be only one upstream dataset"),H(i))}var n,a=[],u=[];return v.each(e,function(c){c.prepareSource();var _=c.getSource(o||0),h="";o!=null&&!_&&(process.env.NODE_ENV!=="production"&&(h="Can not retrieve result by `fromTransformResult`: "+o),H(h)),a.push(_),u.push(c._getVersionSign())}),t?n=U.applyDataTransform(t,a,{datasetIndex:r.componentIndex}):o!=null&&(n=[S.cloneSourceShallow(a[0])]),{sourceList:n,upstreamSignList:u}},s.prototype._isDirty=function(){if(this._dirty)return!0;for(var e=this._getUpstreamSourceManagers(),r=0;r<e.length;r++){var t=e[r];if(t._isDirty()||this._upstreamSignList[r]!==t._getVersionSign())return!0}},s.prototype.getSource=function(e){e=e||0;var r=this._sourceList[e];if(!r){var t=this._getUpstreamSourceManagers();return t[0]&&t[0].getSource(e)}return r},s.prototype.getSharedDataStore=function(e){process.env.NODE_ENV!=="production"&&v.assert(g(this._sourceHost),"Can only call getDataStore on series source manager.");var r=e.makeStoreSchema();return this._innerGetDataStore(r.dimensions,e.source,r.hash)},s.prototype._innerGetDataStore=function(e,r,t){var o=0,i=this._storeList,n=i[o];n||(n=i[o]={});var a=n[t];if(!a){var u=this._getUpstreamSourceManagers()[0];g(this._sourceHost)&&u?a=u._innerGetDataStore(e,r,t):(a=new O.default,a.initData(new V.DefaultDataProvider(r,e.length),e)),n[t]=a}return a},s.prototype._getUpstreamSourceManagers=function(){var e=this._sourceHost;if(g(e)){var r=D.querySeriesUpstreamDatasetModel(e);return r?[r.getSourceManager()]:[]}else return v.map(D.queryDatasetUpstreamDatasetModels(e),function(t){return t.getSourceManager()})},s.prototype._getSourceMetaRawOption=function(){var e=this._sourceHost,r,t,o;if(g(e))r=e.get("seriesLayoutBy",!0),t=e.get("sourceHeader",!0),o=e.get("dimensions",!0);else if(!this._getUpstreamSourceManagers().length){var i=e;r=i.get("seriesLayoutBy",!0),t=i.get("sourceHeader",!0),o=i.get("dimensions",!0)}return{seriesLayoutBy:r,sourceHeader:t,dimensions:o}},s}();function g(s){return s.mainType==="series"}p(g,"isSeries");function H(s){throw new Error(s)}p(H,"doThrow");exports.SourceManager=q;
