"use strict";var X=Object.defineProperty;var l=(a,r)=>X(a,"name",{value:r,configurable:!0});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const L=require("../../model/Series/index.cjs"),s=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/core/util/index.cjs"),M=require("../morphTransitionHelper/index.cjs"),w=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/graphic/Path/index.cjs");require("../../util/graphic/index.cjs");const _=require("../../data/DataDiffer/index.cjs"),R=require("../../util/model/index.cjs"),J=require("../../util/log/index.cjs"),x=require("../basicTransition/index.cjs"),Y=require("../../../../../../zrender@5.6.0/node_modules/zrender/lib/graphic/Displayable/index.cjs");var Q=1e4,Z=0,H=1,V=2,$=R.makeInner();function K(a,r){for(var i=a.dimensions,e=0;e<i.length;e++){var t=a.getDimensionInfo(i[e]);if(t&&t.otherDims[r]===0)return i[e]}}l(K,"getDimension");function ee(a,r,i){var e=a.getDimensionInfo(i),t=e&&e.ordinalMeta;if(e){var u=a.get(e.name,r);return t&&t.categories[u]||u+""}}l(ee,"getValueByDimension");function b(a,r,i,e){var t=e?"itemChildGroupId":"itemGroupId",u=K(a,t);if(u){var n=ee(a,r,u);return n}var d=a.getRawDataItem(r),p=e?"childGroupId":"groupId";if(d&&d[p])return d[p]+"";if(!e)return i||a.getId(r)}l(b,"getGroupId");function z(a){var r=[];return s.each(a,function(i){var e=i.data,t=i.dataGroupId;if(e.count()>Q){process.env.NODE_ENV!=="production"&&J.warn("Universal transition is disabled on large data > 10k.");return}for(var u=e.getIndices(),n=0;n<u.length;n++)r.push({data:e,groupId:b(e,n,t,!1),childGroupId:b(e,n,t,!0),divide:i.divide,dataIndex:n})}),r}l(z,"flattenDataDiffItems");function q(a,r,i){a.traverse(function(e){e instanceof w.default&&x.initProps(e,{style:{opacity:0}},r,{dataIndex:i,isFrom:!0})})}l(q,"fadeInElement");function U(a){if(a.parent){var r=a.getComputedTransform();a.setLocalTransform(r),a.parent.remove(a)}}l(U,"removeEl");function P(a){a.stopAnimation(),a.isGroup&&a.traverse(function(r){r.stopAnimation()})}l(P,"stopAnimation");function ae(a,r,i){var e=x.getAnimationConfig("update",i,r);e&&a.traverse(function(t){if(t instanceof Y.default){var u=x.getOldStyle(t);u&&t.animateFrom({style:u},e)}})}l(ae,"animateElementStyles");function te(a,r){var i=a.length;if(i!==r.length)return!1;for(var e=0;e<i;e++){var t=a[e],u=r[e];if(t.data.getId(t.dataIndex)!==u.data.getId(u.dataIndex))return!1}return!0}l(te,"isAllIdSame");function W(a,r,i){var e=z(a),t=z(r);function u(f,T,o,v,h){(o||f)&&T.animateFrom({style:o&&o!==f?s.extend(s.extend({},o.style),f.style):f.style},h)}l(u,"updateMorphingPathProps");var n=!1,d=Z,p=s.createHashMap(),G=s.createHashMap();e.forEach(function(f){f.groupId&&p.set(f.groupId,!0),f.childGroupId&&G.set(f.childGroupId,!0)});for(var I=0;I<t.length;I++){var S=t[I].groupId;if(G.get(S)){d=H;break}var y=t[I].childGroupId;if(y&&p.get(y)){d=V;break}}function m(f,T){return function(o){var v=o.data,h=o.dataIndex;return T?v.getId(h):f?d===H?o.childGroupId:o.groupId:d===V?o.childGroupId:o.groupId}}l(m,"createKeyGetter");var E=te(e,t),O={};if(!E)for(var I=0;I<t.length;I++){var N=t[I],k=N.data.getItemGraphicEl(N.dataIndex);k&&(O[k.id]=!0)}function C(f,T){var o=e[T],v=t[f],h=v.data.hostModel,g=o.data.getItemGraphicEl(o.dataIndex),c=v.data.getItemGraphicEl(v.dataIndex);if(g===c){c&&ae(c,v.dataIndex,h);return}g&&O[g.id]||c&&(P(c),g?(P(g),U(g),n=!0,M.applyMorphAnimation(M.getPathList(g),M.getPathList(c),v.divide,h,f,u)):q(c,h,f))}l(C,"updateOneToOne"),new _.default(e,t,m(!0,E),m(!1,E),null,"multiple").update(C).updateManyToOne(function(f,T){var o=t[f],v=o.data,h=v.hostModel,g=v.getItemGraphicEl(o.dataIndex),c=s.filter(s.map(T,function(A){return e[A].data.getItemGraphicEl(e[A].dataIndex)}),function(A){return A&&A!==g&&!O[A.id]});g&&(P(g),c.length?(s.each(c,function(A){P(A),U(A)}),n=!0,M.applyMorphAnimation(M.getPathList(c),M.getPathList(g),o.divide,h,f,u)):q(g,h,o.dataIndex))}).updateOneToMany(function(f,T){var o=e[T],v=o.data.getItemGraphicEl(o.dataIndex);if(!(v&&O[v.id])){var h=s.filter(s.map(f,function(c){return t[c].data.getItemGraphicEl(t[c].dataIndex)}),function(c){return c&&c!==v}),g=t[f[0]].data.hostModel;h.length&&(s.each(h,function(c){return P(c)}),v?(P(v),U(v),n=!0,M.applyMorphAnimation(M.getPathList(v),M.getPathList(h),o.divide,g,f[0],u)):s.each(h,function(c){return q(c,g,f[0])}))}}).updateManyToMany(function(f,T){new _.default(T,f,function(o){return e[o].data.getId(e[o].dataIndex)},function(o){return t[o].data.getId(t[o].dataIndex)}).update(function(o,v){C(f[o],T[v])}).execute()}).execute(),n&&s.each(r,function(f){var T=f.data,o=T.hostModel,v=o&&i.getViewOfSeriesModel(o),h=x.getAnimationConfig("update",o,0);v&&o.isAnimationEnabled()&&h&&h.duration>0&&v.group.traverse(function(g){g instanceof w.default&&!g.animators.length&&g.animateFrom({style:{opacity:0}},h)})})}l(W,"transitionBetween");function F(a){var r=a.getModel("universalTransition").get("seriesKey");return r||a.id}l(F,"getSeriesTransitionKey");function B(a){return s.isArray(a)?a.sort().join(","):a}l(B,"convertArraySeriesKeyToString");function D(a){if(a.hostModel)return a.hostModel.getModel("universalTransition").get("divideShape")}l(D,"getDivideShapeFromData");function re(a,r){var i=s.createHashMap(),e=s.createHashMap(),t=s.createHashMap();s.each(a.oldSeries,function(n,d){var p=a.oldDataGroupIds[d],G=a.oldData[d],I=F(n),S=B(I);e.set(S,{dataGroupId:p,data:G}),s.isArray(I)&&s.each(I,function(y){t.set(y,{key:S,dataGroupId:p,data:G})})});function u(n){i.get(n)&&J.warn("Duplicated seriesKey in universalTransition "+n)}return l(u,"checkTransitionSeriesKeyDuplicated"),s.each(r.updatedSeries,function(n){if(n.isUniversalTransitionEnabled()&&n.isAnimationEnabled()){var d=n.get("dataGroupId"),p=n.getData(),G=F(n),I=B(G),S=e.get(I);if(S)process.env.NODE_ENV!=="production"&&u(I),i.set(I,{oldSeries:[{dataGroupId:S.dataGroupId,divide:D(S.data),data:S.data}],newSeries:[{dataGroupId:d,divide:D(p),data:p}]});else if(s.isArray(G)){process.env.NODE_ENV!=="production"&&u(I);var y=[];s.each(G,function(O){var N=e.get(O);N.data&&y.push({dataGroupId:N.dataGroupId,divide:D(N.data),data:N.data})}),y.length&&i.set(I,{oldSeries:y,newSeries:[{dataGroupId:d,data:p,divide:D(p)}]})}else{var m=t.get(G);if(m){var E=i.get(m.key);E||(E={oldSeries:[{dataGroupId:m.dataGroupId,data:m.data,divide:D(m.data)}],newSeries:[]},i.set(m.key,E)),E.newSeries.push({dataGroupId:d,data:p,divide:D(p)})}}}}),i}l(re,"findTransitionSeriesBatches");function j(a,r){for(var i=0;i<a.length;i++){var e=r.seriesIndex!=null&&r.seriesIndex===a[i].seriesIndex||r.seriesId!=null&&r.seriesId===a[i].id;if(e)return i}}l(j,"querySeries");function ie(a,r,i,e){var t=[],u=[];s.each(R.normalizeToArray(a.from),function(n){var d=j(r.oldSeries,n);d>=0&&t.push({dataGroupId:r.oldDataGroupIds[d],data:r.oldData[d],divide:D(r.oldData[d]),groupIdDim:n.dimension})}),s.each(R.normalizeToArray(a.to),function(n){var d=j(i.updatedSeries,n);if(d>=0){var p=i.updatedSeries[d].getData();u.push({dataGroupId:r.oldDataGroupIds[d],data:p,divide:D(p),groupIdDim:n.dimension})}}),t.length>0&&u.length>0&&W(t,u,e)}l(ie,"transitionSeriesFromOpt");function ne(a){a.registerUpdateLifecycle("series:beforeupdate",function(r,i,e){s.each(R.normalizeToArray(e.seriesTransition),function(t){s.each(R.normalizeToArray(t.to),function(u){for(var n=e.updatedSeries,d=0;d<n.length;d++)(u.seriesIndex!=null&&u.seriesIndex===n[d].seriesIndex||u.seriesId!=null&&u.seriesId===n[d].id)&&(n[d][L.SERIES_UNIVERSAL_TRANSITION_PROP]=!0)})})}),a.registerUpdateLifecycle("series:transition",function(r,i,e){var t=$(i);if(t.oldSeries&&e.updatedSeries&&e.optionChanged){var u=e.seriesTransition;if(u)s.each(R.normalizeToArray(u),function(m){ie(m,t,e,i)});else{var n=re(t,e);s.each(n.keys(),function(m){var E=n.get(m);W(E.oldSeries,E.newSeries,i)})}s.each(e.updatedSeries,function(m){m[L.SERIES_UNIVERSAL_TRANSITION_PROP]&&(m[L.SERIES_UNIVERSAL_TRANSITION_PROP]=!1)})}for(var d=r.getSeries(),p=t.oldSeries=[],G=t.oldDataGroupIds=[],I=t.oldData=[],S=0;S<d.length;S++){var y=d[S].getData();y.count()<Q&&(p.push(d[S]),G.push(d[S].get("dataGroupId")),I.push(y))}})}l(ne,"installUniversalTransition");exports.installUniversalTransition=ne;
